<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-rfc docs-version-current docs-doc-page docs-doc-id-rfc-014" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.9.1">
<title data-rh="true">Layered Data Access Patterns | Prism</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://jrepp.github.io/prism-data-layer/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://jrepp.github.io/prism-data-layer/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://jrepp.github.io/prism-data-layer/rfc/rfc-014"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-rfc-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-rfc-current"><meta data-rh="true" property="og:title" content="Layered Data Access Patterns | Prism"><meta data-rh="true" name="description" content="Abstract"><meta data-rh="true" property="og:description" content="Abstract"><link data-rh="true" rel="icon" href="/prism-data-layer/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://jrepp.github.io/prism-data-layer/rfc/rfc-014"><link data-rh="true" rel="alternate" href="https://jrepp.github.io/prism-data-layer/rfc/rfc-014" hreflang="en"><link data-rh="true" rel="alternate" href="https://jrepp.github.io/prism-data-layer/rfc/rfc-014" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Layered Data Access Patterns • RFC-014","item":"https://jrepp.github.io/prism-data-layer/rfc/rfc-014"}]}</script><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,user-scalable=yes">
<meta name="theme-color" content="#6366f1">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><link rel="stylesheet" href="/prism-data-layer/assets/css/styles.73adf43b.css">
<script src="/prism-data-layer/assets/js/runtime~main.1e08d1ff.js" defer="defer"></script>
<script src="/prism-data-layer/assets/js/main.988b29ad.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",t||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")),document.documentElement.setAttribute("data-theme-choice",t||"system")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/prism-data-layer/"><div class="navbar__logo"><img src="/prism-data-layer/img/prism-logo-transparent-background.png" alt="Prism Data Gateway Logo" class="themedComponent_mlkZ themedComponent--light_NVdE" height="32" width="32"><img src="/prism-data-layer/img/prism-logo-transparent-background.png" alt="Prism Data Gateway Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU" height="32" width="32"></div><b class="navbar__title text--truncate">Prism</b></a><a class="navbar__item navbar__link" href="/prism-data-layer/docs/intro">Overview</a><a class="navbar__item navbar__link" href="/prism-data-layer/docs/changelog">Change Log</a><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Documentation</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/prism-data-layer/adr">ADRs (Architecture Decision Records)</a></li><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/prism-data-layer/rfc">RFCs (Request for Comments)</a></li><li><a class="dropdown__link" href="/prism-data-layer/memos">Memos (Technical Analysis)</a></li><li><a class="dropdown__link" href="/prism-data-layer/prds">PRDs (Product Requirements)</a></li></ul></div></div><div class="navbar__items navbar__items--right"><div class="buildInfo_asc2"><span class="version_ADrX" title="Build: d884409">d884409</span><span class="separator_VfCt">•</span><span class="buildTime_n1Nn" title="Last updated: Oct 14, 9:46 AM PDT">Oct 14, 9:46 AM PDT</span></div><div class="navbar__item"><a href="https://github.com/jrepp/prism-data-layer/actions/workflows/docs.yml" target="_blank" rel="noopener noreferrer" title="GitHub Pages" style="display: flex; align-items: center; padding: 0 0.5rem;"><img src="https://github.com/jrepp/prism-data-layer/actions/workflows/docs.yml/badge.svg" alt="Build" style="margin: 0;"></a></div><a href="https://github.com/jrepp/prism-data-layer" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle_vylO colorModeToggle_x44X"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><div class="navbar__search searchBarContainer_NW3z" dir="ltr"><input placeholder="Search" aria-label="Search" class="navbar__search-input searchInput_YFbd" value=""><div class="loadingRing_RJI3 searchBarLoadingRing_YnHq"><div></div><div></div><div></div><div></div></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/prism-data-layer/rfc/"><span title="Request for Comments (RFCs)" class="linkLabel_WmDU">Request for Comments (RFCs)</span></a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/prism-data-layer/rfc/rfc-001"><span title="RFC-001 to 010" class="categoryLinkLabel_W154">RFC-001 to 010</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" href="/prism-data-layer/rfc/rfc-011"><span title="RFC-011 to 020" class="categoryLinkLabel_W154">RFC-011 to 020</span></a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/prism-data-layer/rfc/rfc-011"><span title="Data Proxy Authentication (Input/Output) • RFC-011" class="linkLabel_WmDU">Data Proxy Authentication (Input/Output) • RFC-011</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/prism-data-layer/rfc/rfc-012"><span title="Prism Network Gateway (prism-netgw) - Multi-Region Control Plane • RFC-012" class="linkLabel_WmDU">Prism Network Gateway (prism-netgw) - Multi-Region Control Plane • RFC-012</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/prism-data-layer/rfc/rfc-013"><span title="Neptune Graph Backend Implementation • RFC-013" class="linkLabel_WmDU">Neptune Graph Backend Implementation • RFC-013</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/prism-data-layer/rfc/rfc-014"><span title="Layered Data Access Patterns • RFC-014" class="linkLabel_WmDU">Layered Data Access Patterns • RFC-014</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/prism-data-layer/rfc/rfc-015"><span title="Plugin Acceptance Test Framework (Interface-Based Testing) • RFC-015" class="linkLabel_WmDU">Plugin Acceptance Test Framework (Interface-Based Testing) • RFC-015</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/prism-data-layer/rfc/rfc-016"><span title="Local Development Infrastructure • RFC-016" class="linkLabel_WmDU">Local Development Infrastructure • RFC-016</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/prism-data-layer/rfc/rfc-017"><span title="Multicast Registry Pattern • RFC-017" class="linkLabel_WmDU">Multicast Registry Pattern • RFC-017</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/prism-data-layer/rfc/rfc-018"><span title="POC Implementation Strategy • RFC-018" class="linkLabel_WmDU">POC Implementation Strategy • RFC-018</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/prism-data-layer/rfc/rfc-019"><span title="Pattern SDK Authorization Layer - Token Validation and Policy Enforcement • RFC-019" class="linkLabel_WmDU">Pattern SDK Authorization Layer - Token Validation and Policy Enforcement • RFC-019</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/prism-data-layer/rfc/rfc-020"><span title="Streaming HTTP Listener - API-Specific Adapter Pattern • RFC-020" class="linkLabel_WmDU">Streaming HTTP Listener - API-Specific Adapter Pattern • RFC-020</span></a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/prism-data-layer/rfc/rfc-021"><span title="RFC-021 to 030" class="categoryLinkLabel_W154">RFC-021 to 030</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/prism-data-layer/rfc/rfc-031"><span title="RFC-031 to 040" class="categoryLinkLabel_W154">RFC-031 to 040</span></a></div></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_z5aJ"><div class="docItemContainer_c0TR"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/prism-data-layer/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">RFC-011 to 020</span></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">Layered Data Access Patterns • RFC-014</span></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="docMetadata_NQcq"><div class="tagsRow_ipDH"><span class="tag_VbXK">architecture</span><span class="tag_VbXK">patterns</span><span class="tag_VbXK">composition</span><span class="tag_VbXK">data-access</span><span class="tag_VbXK">layering</span></div><div class="metadataRow_PvZM"><span class="metadataItem_RMFE info_Qo8L"><strong>Status:</strong> <!-- -->Proposed</span><span class="metadataItem_RMFE"><strong>Author:</strong> <!-- -->Platform Team</span><span class="metadataItem_RMFE"><strong>Created:</strong> <!-- -->Oct 8, 2025</span><span class="metadataItem_RMFE"><strong>Updated:</strong> <!-- -->Oct 8, 2025</span></div></div><div class="theme-doc-markdown markdown"><header><h1>Layered Data Access Patterns</h1></header><h2 class="anchor anchorWithStickyNavbar_LWe7" id="abstract">Abstract<a href="#abstract" class="hash-link" aria-label="Direct link to Abstract" title="Direct link to Abstract" translate="no">​</a></h2>
<p>This RFC specifies how Prism separates the <strong>client API</strong> (data access patterns like Queue, PubSub, Reader) from the <strong>backend implementation</strong> (composed strategies for satisfying those APIs). By layering reliability patterns (Claim Check, Outbox, CDC, Tiered Storage) beneath client-facing interfaces, Prism enables powerful data access capabilities without exposing complexity to applications.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="motivation">Motivation<a href="#motivation" class="hash-link" aria-label="Direct link to Motivation" title="Direct link to Motivation" translate="no">​</a></h2>
<p>Modern distributed applications require complex reliability patterns, but implementing them correctly is difficult:</p>
<p><strong>Problems</strong>:</p>
<ul>
<li>Applications must implement reliability logic (claim check, outbox, tiered storage) themselves</li>
<li>Backend-specific logic leaks into application code</li>
<li>Switching backends requires rewriting application logic</li>
<li>Patterns (e.g., Claim Check + Pub/Sub) must be composed manually</li>
<li>Testing reliability patterns requires complex infrastructure</li>
</ul>
<p><strong>Solution</strong>: Prism provides a <strong>layered architecture</strong> that separates concerns:</p>
<p>┌──────────────────────────────────────────────────────────┐
│         Layer 3: Client API (What)                       │
│  Queue | PubSub | Reader | Transact | Cache             │
│  &quot;I want to publish messages to a queue&quot;                 │
└──────────────────────────────────────────────────────────┘
│
▼
┌──────────────────────────────────────────────────────────┐
│         Layer 2: Pattern Composition (How)               │
│  Claim Check | Outbox | CDC | Tiered Storage | WAL      │
│  &quot;Automatically store large payloads in S3&quot;              │
└──────────────────────────────────────────────────────────┘
│
▼
┌──────────────────────────────────────────────────────────┐
│         Layer 1: Backend Execution (Where)               │
│  Kafka | NATS | Postgres | Redis | S3 | ClickHouse      │
│  &quot;Connect to and execute operations on backend&quot;          │
└──────────────────────────────────────────────────────────┘</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">**Goals:**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- Define clear separation between client API and backend strategies</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- Document how to compose multiple patterns for a single API</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- Provide configuration-based pattern selection</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- Enable testing patterns independently</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- Support backend migration without client changes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">**Non-Goals:**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- Runtime pattern switching (patterns chosen at namespace creation)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- Arbitrary pattern composition (only compatible patterns can layer)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- Application-level customization of patterns (Prism controls implementation)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">## Client Pattern Catalog</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">This section shows **how application owners request high-level patterns** without needing to understand internal implementation. Each pattern maps to common application problems.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">### Pattern 1: Durable Operation Log (WAL - Write-Ahead Log)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">**Application Problem:**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">You need **guaranteed durability** for operations - write operations must be persisted to disk before being acknowledged, and consumers must reliably process and acknowledge each operation. This is critical for financial transactions, order processing, audit logs, or any scenario where **operations cannot be lost**.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">**What You Get:**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- **Durability guarantee**: Operations persisted to disk before acknowledgment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- **Reliable consumption**: Consumers must explicitly acknowledge each operation</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- **Crash recovery**: Operations survive proxy/consumer crashes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- **Replay capability**: Re-process operations from any point in the log</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- **Ordered processing**: Operations processed in write order</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">**Why WAL is Critical for Reliability:**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<p>sequenceDiagram
participant App as Application
participant Proxy as Prism Proxy
participant WAL as WAL (Disk)
participant Consumer as Consumer
participant Backend as Backend (Kafka)</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Note over App,Backend: Write Path (Durability)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">App-&gt;&gt;Proxy: Publish operation</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Proxy-&gt;&gt;WAL: 1. Append to WAL (fsync)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">WAL--&gt;&gt;Proxy: 2. Persisted to disk</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Proxy--&gt;&gt;App: 3. Acknowledge (operation durable)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Note over Proxy,Backend: Async flush to backend</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Proxy-&gt;&gt;Backend: 4. Flush WAL → Kafka</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Backend--&gt;&gt;Proxy: 5. Kafka acknowledged</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Note over Consumer,Backend: Read Path (Reliable Consumption)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Consumer-&gt;&gt;Backend: 6. Consume from Kafka</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Backend--&gt;&gt;Consumer: 7. Operation data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Consumer-&gt;&gt;Consumer: 8. Process operation</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Consumer-&gt;&gt;Backend: 9. Acknowledge (committed offset)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Note over App,Backend: Crash Recovery</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Proxy-&gt;&gt;WAL: On restart: Read uncommitted WAL entries</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Proxy-&gt;&gt;Backend: Replay to backend</span><br></span></code></pre></div></div>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">**Client Configuration:**</span><br></span></code></pre></div></div>
<h1>Declare what you need - Prism handles the rest</h1>
<p>namespaces:</p>
<ul>
<li>
<p>name: order-processing
pattern: durable-queue      # What pattern you need</p>
<h1>Tell Prism what guarantees you need</h1>
<p>needs:
durability: strong        # → Prism adds WAL with fsync
replay: enabled           # → Prism keeps committed log for replay
retention: 30days         # → Prism retains WAL for 30 days
ordered: true             # → Prism guarantees order</p>
</li>
</ul>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">**Client Code (Producer):**</span><br></span></code></pre></div></div>
<h1>Application publishes operation - Prism ensures durability</h1>
<p>order = {&quot;order_id&quot;: 12345, &quot;amount&quot;: 99.99, &quot;status&quot;: &quot;pending&quot;}</p>
<h1>Operation is persisted to WAL BEFORE acknowledgment</h1>
<p>response = client.publish(&quot;orders&quot;, order)</p>
<h1>At this point:</h1>
<h1>✓ Operation written to disk (survived crash)</h1>
<h1>✓ Will be delivered to consumers</h1>
<h1>✓ Can be replayed if needed</h1>
<p>print(&quot;Order persisted:&quot;, response.offset)</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">**Client Code (Consumer):**</span><br></span></code></pre></div></div>
<h1>Consumer must explicitly acknowledge each operation</h1>
<p>for operation in client.consume(&quot;orders&quot;):
try:
# Process the operation
result = process_order(operation.payload)</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    # MUST acknowledge after successful processing</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    operation.ack()  # Commits offset, operation won&#x27;t be redelivered</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">except Exception as e:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # On failure: don&#x27;t ack, operation will be retried</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    logging.error(f&quot;Failed to process order: {e}&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    operation.nack()  # Explicit negative ack (immediate retry)</span><br></span></code></pre></div></div>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">**What Happens Internally:**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1. **Write Path (Producer)**:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - **Layer 3**: Client calls `publish()`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - **Layer 2**: WAL pattern writes to local append-only log on disk</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - **Layer 2**: Calls `fsync()` to ensure durability (survives crash)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - **Layer 3**: Returns acknowledgment to client</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - **Background**: WAL flusher asynchronously sends to Kafka</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2. **Read Path (Consumer)**:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - **Layer 1**: Consumer reads from Kafka</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - **Layer 2**: WAL pattern tracks consumer position</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - **Consumer**: Processes operation</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - **Consumer**: Calls `operation.ack()` to commit progress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - **Layer 2**: Updates consumer offset (operation marked consumed)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3. **Crash Recovery**:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - **On proxy restart**: Read uncommitted WAL entries from disk</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - **Layer 2**: Replay uncommitted operations to Kafka</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - **Guarantee**: Zero lost operations</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">**Real-World Example:**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Problem: E-commerce order processing - cannot lose orders</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Challenge: Proxy crashes between accepting order and publishing to Kafka</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Before Prism (without WAL):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  1. Accept order HTTP request</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  2. Publish to Kafka</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  3. (CRASH HERE) → Order lost forever</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  4. Return 200 OK to customer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Result: Customer charged, order never processed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">With Prism WAL:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  1. Accept order HTTP request</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  2. Write to WAL on disk (fsync)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  3. Return 200 OK to customer (order persisted)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  4. (CRASH HERE) → WAL entry on disk</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  5. On restart: Replay WAL → Kafka</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Result: Zero lost orders, customer trust maintained</span><br></span></code></pre></div></div>
<p><strong>Performance Characteristics:</strong></p>
<ul>
<li>Write latency: <strong>2-5ms</strong> (includes fsync to disk)</li>
<li>Throughput: <strong>10k-50k operations/sec</strong> per proxy instance</li>
<li>Durability: <strong>Survives crashes, power loss</strong></li>
<li>Trade-off: Slightly higher latency vs in-memory queue, but <strong>zero data loss</strong></li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="pattern-2-large-payload-pubsub-claim-check">Pattern 2: Large Payload Pub/Sub (Claim Check)<a href="#pattern-2-large-payload-pubsub-claim-check" class="hash-link" aria-label="Direct link to Pattern 2: Large Payload Pub/Sub (Claim Check)" title="Direct link to Pattern 2: Large Payload Pub/Sub (Claim Check)" translate="no">​</a></h3>
<p><strong>Application Problem:</strong>
You need to publish large files (videos, ML models, datasets) but message queues have size limits (Kafka: 10MB, NATS: 8MB).</p>
<p><strong>What You Get:</strong></p>
<ul>
<li>Publish files up to 5GB through standard <code>publish()</code> API</li>
<li>Automatic storage management (S3/Blob)</li>
<li>Transparent retrieval for subscribers</li>
<li>Automatic cleanup after consumption</li>
</ul>
<p><strong>Client Configuration:</strong></p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">namespaces:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - name: video-processing</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pattern: pubsub</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    needs:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      max_message_size: 5GB        # → Prism adds Claim Check</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      storage_backend: s3          # → Prism configures S3 storage</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      cleanup: on_consume          # → Prism auto-deletes after read</span><br></span></code></pre></div></div>
<p><strong>Client Code:</strong></p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># Publisher: Send large video file (no special handling)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">video_bytes = open(&quot;movie.mp4&quot;, &quot;rb&quot;).read()  # 2.5GB</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">client.publish(&quot;videos&quot;, video_bytes)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Prism: Detects size &gt; threshold, stores in S3, publishes reference</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Subscriber: Receive full video (transparent retrieval)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">event = client.subscribe(&quot;videos&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">video_bytes = event.payload  # Full 2.5GB reconstructed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">process_video(video_bytes)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Prism: Fetches from S3, deletes S3 object after consumption</span><br></span></code></pre></div></div>
<p><strong>What Happens Internally:</strong></p>
<ol>
<li><strong>Layer 3</strong>: Client calls <code>publish(2.5GB payload)</code></li>
<li><strong>Layer 2</strong>: Claim Check detects size &gt; 1MB threshold</li>
<li><strong>Layer 2</strong>: Stores payload in S3, generates claim check ID</li>
<li><strong>Layer 1</strong>: Publishes lightweight message to Kafka (just metadata)</li>
</ol>
<p><strong>Real-World Example:</strong>
Problem: ML team publishes 50GB model weights per training run
Before Prism: Manual S3 upload + manual message with S3 key
With Prism: Standard publish() API, Prism handles everything</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">### Pattern 3: Transactional Messaging (Outbox)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">**Application Problem:**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">You need guaranteed message delivery when updating database - no lost messages, no duplicates, even if Kafka is down.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">**What You Get:**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- Atomic database update + message publish</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- Guaranteed delivery (survives crashes, Kafka outages)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- Exactly-once semantics</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- No dual-write problems</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">**Client Configuration:**</span><br></span></code></pre></div></div>
<p>namespaces:</p>
<ul>
<li>
<p>name: order-processing
pattern: queue</p>
<p>needs:
consistency: strong          # → Prism adds Outbox pattern
delivery_guarantee: exactly_once</p>
</li>
</ul>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">**Client Code:**</span><br></span></code></pre></div></div>
<h1>Application code: Atomically update DB and publish event</h1>
<p>with client.transaction() as tx:
# 1. Update database
tx.execute(&quot;UPDATE orders SET status=&#x27;completed&#x27; WHERE id=$1&quot;, order_id)</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 2. Publish event (atomic with DB update)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tx.publish(&quot;order-events&quot;, {&quot;order_id&quot;: order_id, &quot;status&quot;: &quot;completed&quot;})</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># If commit succeeds, event WILL be published eventually</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># If commit fails, event is NOT published</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tx.commit()</span><br></span></code></pre></div></div>
<h1>Prism handles background publishing from outbox table</h1>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">**What Happens Internally:**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1. **Layer 3**: Client calls `tx.publish()`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2. **Layer 2**: Outbox pattern inserts into `outbox` table (same transaction)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3. **Layer 1**: Transaction commits to Postgres</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4. **Background**: Outbox publisher polls table, publishes to Kafka, marks published</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">**Real-World Example:**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Problem: E-commerce order completion must trigger notification</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Before Prism: Dual write bug caused missed notifications</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">With Prism: Outbox pattern guarantees delivery</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="pattern-4-change-data-capture-with-kafka-cdc--outbox">Pattern 4: Change Data Capture with Kafka (CDC + Outbox)<a href="#pattern-4-change-data-capture-with-kafka-cdc--outbox" class="hash-link" aria-label="Direct link to Pattern 4: Change Data Capture with Kafka (CDC + Outbox)" title="Direct link to Pattern 4: Change Data Capture with Kafka (CDC + Outbox)" translate="no">​</a></h3>
<p><strong>Application Problem:</strong>
You need to stream database changes to other systems (cache, search index, analytics) without dual writes.</p>
<p><strong>What You Get:</strong></p>
<ul>
<li>Automatic capture of database changes (INSERT/UPDATE/DELETE)</li>
<li>Stream changes to Kafka for consumption</li>
<li>No application code changes required</li>
<li>Guaranteed ordering per key</li>
</ul>
<p><strong>Client Configuration:</strong></p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">namespaces:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - name: user-profiles</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pattern: reader  # Normal database reads/writes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # Enable CDC streaming</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cdc:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      enabled: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      source: postgres             # → Prism captures PostgreSQL WAL</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      destination: kafka           # → Prism streams to Kafka</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      topic: user-profile-changes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      # What to capture</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      tables: [user_profiles]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      operations: [INSERT, UPDATE, DELETE]</span><br></span></code></pre></div></div>
<p><strong>Client Code:</strong></p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># Application: Normal database operations (no CDC code!)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">client.update(&quot;user_profiles&quot;, user_id, {&quot;email&quot;: &quot;new@email.com&quot;})</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Prism automatically publishes CDC event to Kafka:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#   &quot;operation&quot;: &quot;UPDATE&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#   &quot;table&quot;: &quot;user_profiles&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#   &quot;before&quot;: {&quot;email&quot;: &quot;old@email.com&quot;},</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#   &quot;after&quot;: {&quot;email&quot;: &quot;new@email.com&quot;},</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#   &quot;timestamp&quot;: &quot;2025-10-09T10:30:00Z&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Other systems consume from Kafka:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">def cache_invalidator():</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for change in kafka.consume(&quot;user-profile-changes&quot;):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if change.operation in [&quot;UPDATE&quot;, &quot;DELETE&quot;]:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            redis.delete(f&quot;user:{change.after.id}:profile&quot;)</span><br></span></code></pre></div></div>
<p><strong>What Happens Internally:</strong></p>
<ol>
<li><strong>Layer 3</strong>: Client calls <code>update()</code></li>
<li><strong>Layer 1</strong>: Postgres executes UPDATE</li>
<li><strong>Layer 2</strong>: CDC pattern captures WAL entry</li>
<li><strong>Layer 2</strong>: Transforms WAL → CDC event</li>
<li><strong>Layer 1</strong>: Publishes to Kafka topic</li>
</ol>
<p><strong>Real-World Example:</strong>
Problem: Keep Elasticsearch search index synced with PostgreSQL
Before Prism: Dual write (update DB, update ES) - race conditions
With Prism: CDC automatically streams changes, ES consumes</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">### Pattern 5: Transactional Large Payloads (Outbox + Claim Check)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">**Application Problem:**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">You need BOTH transactional guarantees (outbox) AND large payload support (claim check) - ML model releases, video uploads with metadata.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">**What You Get:**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- Atomic transaction (if commit succeeds, event will be published)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- Large payload support (up to 5GB)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- No Kafka/NATS size limits</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- Exactly-once delivery</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">**Client Configuration:**</span><br></span></code></pre></div></div>
<p>namespaces:</p>
<ul>
<li>
<p>name: ml-model-releases
pattern: pubsub</p>
<p>needs:
consistency: strong           # → Prism adds Outbox
max_message_size: 5GB        # → Prism adds Claim Check
delivery_guarantee: exactly_once</p>
</li>
</ul>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">**Client Code:**</span><br></span></code></pre></div></div>
<h1>Application: Publish large model with transactional guarantee</h1>
<p>model_weights = load_model(&quot;model-v2.weights&quot;)  # 2GB</p>
<p>with client.transaction() as tx:
# Update model registry
tx.execute(&quot;&quot;&quot;
INSERT INTO model_registry (name, version, status)
VALUES ($1, $2, &#x27;published&#x27;)
&quot;&quot;&quot;, &quot;my-model&quot;, &quot;v2&quot;)</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># Publish model (2GB payload, transactional)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tx.publish(&quot;model-releases&quot;, {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;model_name&quot;: &quot;my-model&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;version&quot;: &quot;v2&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;weights&quot;: model_weights  # 2GB</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">})</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tx.commit()</span><br></span></code></pre></div></div>
<h1>If commit succeeds: model will be published</h1>
<h1>If commit fails: S3 object is cleaned up, no message sent</h1>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">**What Happens Internally:**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1. **Layer 3**: Client calls `tx.publish(2GB)`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2. **Layer 2**: Claim Check stores 2GB in S3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3. **Layer 2**: Outbox inserts `{claim_check_id}` into outbox table</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4. **Layer 1**: Transaction commits to Postgres</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">5. **Background**: Outbox publisher sends lightweight Kafka message</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">**Real-World Example:**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Problem: ML platform releases 50GB models, needs atomic model registry + notification</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Before Prism: Manual S3 + outbox implementation, 500 LOC</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">With Prism: Standard transactional API, Prism composes patterns</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="pattern-6-cached-reads-with-auto-invalidation-cache--cdc">Pattern 6: Cached Reads with Auto-Invalidation (Cache + CDC)<a href="#pattern-6-cached-reads-with-auto-invalidation-cache--cdc" class="hash-link" aria-label="Direct link to Pattern 6: Cached Reads with Auto-Invalidation (Cache + CDC)" title="Direct link to Pattern 6: Cached Reads with Auto-Invalidation (Cache + CDC)" translate="no">​</a></h3>
<p><strong>Application Problem:</strong>
You need fast cached reads but cache must stay fresh when database changes.</p>
<p><strong>What You Get:</strong></p>
<ul>
<li>Lightning-fast reads (Redis cache)</li>
<li>Automatic cache invalidation on updates</li>
<li>No stale data</li>
<li>No application cache management code</li>
</ul>
<p><strong>Client Configuration:</strong></p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">namespaces:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - name: product-catalog</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pattern: reader</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # Enable caching with CDC invalidation</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cache:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      enabled: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      backend: redis</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ttl: 900  # 15 min fallback</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cdc:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      enabled: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      destination: cache_invalidator</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      operations: [UPDATE, DELETE]</span><br></span></code></pre></div></div>
<p><strong>Client Code:</strong></p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># Application: Just read - Prism handles caching</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">product = client.get(&quot;products&quot;, product_id)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># First read: Cache miss → Query Postgres → Populate cache</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Subsequent reads: Cache hit → Return from Redis (sub-ms)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Another service updates product</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">other_service.update(&quot;products&quot;, product_id, {&quot;price&quot;: 29.99})</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Prism CDC: Detects change, invalidates cache automatically</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Next read: Cache miss (invalidated) → Fresh data from Postgres</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">product = client.get(&quot;products&quot;, product_id)  # Gets updated price</span><br></span></code></pre></div></div>
<p><strong>What Happens Internally:</strong></p>
<ol>
<li><strong>Read Path</strong>: Client → Check Redis → (miss) → Query Postgres → Cache in Redis</li>
<li><strong>Write Path</strong>: Update Postgres → CDC captures change → Invalidate Redis key</li>
<li><strong>Next Read</strong>: Cache miss → Fresh data</li>
</ol>
<p><strong>Real-World Example:</strong>
Problem: Product catalog with millions of reads/sec, frequent price updates
Before Prism: Manual cache + manual invalidation, stale data bugs
With Prism: Declare cache + CDC, Prism handles everything</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">### Pattern Selection Guide</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| Use Case | Recommended Pattern | Configuration |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|----------|-------------------|---------------|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| **High-volume logging** | WAL + Tiered Storage | `write_rps: 100k+`, `retention: 90days` |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| **Large files (videos, models)** | Claim Check | `max_message_size: &gt;1MB` |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| **Transactional events** | Outbox | `consistency: strong` |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| **Database change streaming** | CDC | `cdc.enabled: true` |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| **Large + transactional** | Outbox + Claim Check | Both requirements |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| **Fast cached reads** | Cache + CDC | `cache.enabled: true`, `cdc.enabled: true` |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| **Event sourcing** | WAL + Event Store | `audit: true`, `replay: enabled` |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">### How Prism Selects Patterns</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Application owners declare **requirements**, Prism selects **patterns**:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<h1>Application declares &quot;what&quot; they need</h1>
<p>namespaces:</p>
<ul>
<li>name: video-uploads
needs:
write_rps: 5000                    # High throughput
max_message_size: 5GB              # Large payloads
consistency: strong                # Transactional
retention: 30days                  # Long-term storage</li>
</ul>
<h1>Prism generates &quot;how&quot; to implement it</h1>
<h1>Internally translates to:</h1>
<h1>patterns: [WAL, Outbox, Claim Check, Tiered Storage]</h1>
<h1>backend: [Kafka, S3, Postgres]</h1>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Application owners **never write pattern composition logic** - they declare needs, Prism handles the rest.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">## Architecture Overview</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">### Proxy Internal Structure</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">The Prism proxy is structured to cleanly separate concerns across layers:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<p>graph TB
subgraph &quot;External&quot;
Client[Client Application]
end</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">subgraph &quot;Prism Proxy&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    subgraph &quot;Frontend Layer&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        gRPC[gRPC Server&lt;br/&gt;:8980]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Auth[Authentication&lt;br/&gt;Middleware]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        SessionMgr[Session&lt;br/&gt;Manager]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    subgraph &quot;API Layer (Layer 3)&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        QueueAPI[Queue API]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        PubSubAPI[PubSub API]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ReaderAPI[Reader API]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        TransactAPI[Transact API]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    subgraph &quot;Pattern Layer (Layer 2)&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        direction LR</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        PatternChain[Pattern Chain&lt;br/&gt;Executor]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        subgraph &quot;Patterns&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Outbox[Outbox&lt;br/&gt;Pattern]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ClaimCheck[Claim Check&lt;br/&gt;Pattern]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            CDC[CDC&lt;br/&gt;Pattern]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Tiered[Tiered Storage&lt;br/&gt;Pattern]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            WAL[WAL&lt;br/&gt;Pattern]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    subgraph &quot;Backend Layer (Layer 1)&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        BackendRouter[Backend&lt;br/&gt;Router]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        subgraph &quot;Backend Connectors&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            KafkaConn[Kafka&lt;br/&gt;Connector]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            PGConn[PostgreSQL&lt;br/&gt;Connector]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            S3Conn[S3&lt;br/&gt;Connector]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            RedisConn[Redis&lt;br/&gt;Connector]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    subgraph &quot;Observability&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Metrics[Prometheus&lt;br/&gt;Metrics]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Traces[OpenTelemetry&lt;br/&gt;Traces]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Logs[Structured&lt;br/&gt;Logs]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">subgraph &quot;Backends&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Kafka[(Kafka)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Postgres[(PostgreSQL)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    S3[(S3)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Redis[(Redis)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Client --&gt;|mTLS/JWT| gRPC</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gRPC --&gt; Auth</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Auth --&gt;|Validate| SessionMgr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SessionMgr --&gt; QueueAPI</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SessionMgr --&gt; PubSubAPI</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SessionMgr --&gt; ReaderAPI</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SessionMgr --&gt; TransactAPI</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">QueueAPI --&gt; PatternChain</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PubSubAPI --&gt; PatternChain</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ReaderAPI --&gt; PatternChain</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">TransactAPI --&gt; PatternChain</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PatternChain --&gt;|Execute| Outbox</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PatternChain --&gt;|Execute| ClaimCheck</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PatternChain --&gt;|Execute| CDC</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PatternChain --&gt;|Execute| Tiered</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PatternChain --&gt;|Execute| WAL</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Outbox --&gt; BackendRouter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ClaimCheck --&gt; BackendRouter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CDC --&gt; BackendRouter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Tiered --&gt; BackendRouter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">WAL --&gt; BackendRouter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">BackendRouter --&gt;|Route| KafkaConn</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">BackendRouter --&gt;|Route| PGConn</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">BackendRouter --&gt;|Route| S3Conn</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">BackendRouter --&gt;|Route| RedisConn</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">KafkaConn --&gt; Kafka</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PGConn --&gt; Postgres</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">S3Conn --&gt; S3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RedisConn --&gt; Redis</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PatternChain -.-&gt;|Emit| Metrics</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PatternChain -.-&gt;|Emit| Traces</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PatternChain -.-&gt;|Emit| Logs</span><br></span></code></pre></div></div>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">### Authentication and Authorization Flow</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<p>sequenceDiagram
participant Client
participant gRPC as gRPC Server
participant Auth as Auth Middleware
participant JWT as JWT Validator
participant RBAC as RBAC Policy Engine
participant Session as Session Manager
participant API as API Layer</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Client-&gt;&gt;gRPC: Request + JWT Token</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gRPC-&gt;&gt;Auth: Intercept Request</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Auth-&gt;&gt;JWT: Validate Token</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">JWT-&gt;&gt;JWT: Check signature&lt;br/&gt;Check expiry&lt;br/&gt;Extract claims</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">alt Token Valid</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    JWT--&gt;&gt;Auth: Claims {user, groups, scopes}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Auth-&gt;&gt;RBAC: Authorize Operation</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    RBAC-&gt;&gt;RBAC: Check namespace access&lt;br/&gt;Check operation permission&lt;br/&gt;Check rate limits</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    alt Authorized</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        RBAC--&gt;&gt;Auth: Allow</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Auth-&gt;&gt;Session: Get/Create Session</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Session--&gt;&gt;Auth: Session Context</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Auth-&gt;&gt;API: Forward Request + Context</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        API--&gt;&gt;Client: Response</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    else Not Authorized</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        RBAC--&gt;&gt;Auth: Deny</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Auth--&gt;&gt;Client: PermissionDenied (7)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">else Token Invalid</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    JWT--&gt;&gt;Auth: Error</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Auth--&gt;&gt;Client: Unauthenticated (16)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span></code></pre></div></div>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">### Pattern Layer Execution Flow</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<p>sequenceDiagram
participant API as API Layer (Layer 3)
participant Chain as Pattern Chain
participant P1 as Pattern 1<br>(Outbox)
participant P2 as Pattern 2<br>(Claim Check)
participant Backend as Backend Layer (Layer 1)
participant Obs as Observability</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Note over API,Obs: Publish Flow</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">API-&gt;&gt;Chain: Publish(topic, payload, metadata)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Chain-&gt;&gt;Obs: Start Trace &quot;publish&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Chain-&gt;&gt;P1: process_publish(ctx)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">P1-&gt;&gt;Obs: Span &quot;outbox-pattern&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">P1-&gt;&gt;P1: BEGIN TRANSACTION</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">P1-&gt;&gt;P1: ctx = wrap in outbox</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">P1-&gt;&gt;Obs: Metric: outbox_inserted++</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">P1-&gt;&gt;P2: Continue with modified ctx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">P2-&gt;&gt;Obs: Span &quot;claim-check-pattern&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">alt Payload &gt; Threshold</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    P2-&gt;&gt;Backend: Store payload in S3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Backend--&gt;&gt;P2: S3 URL</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    P2-&gt;&gt;P2: Replace payload with&lt;br/&gt;claim_check_id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    P2-&gt;&gt;Obs: Metric: claim_check_stored++</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">P2-&gt;&gt;P1: Return modified ctx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">P1-&gt;&gt;Backend: INSERT INTO outbox</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">P1-&gt;&gt;P1: COMMIT TRANSACTION</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">P1-&gt;&gt;Chain: Success</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Chain-&gt;&gt;Obs: End Trace (duration: 52ms)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Chain-&gt;&gt;API: PublishResponse</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Note over API,Obs: Background: Outbox Publisher</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">loop Every 100ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    P1-&gt;&gt;Backend: SELECT unpublished FROM outbox</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    P1-&gt;&gt;Backend: Publish to Kafka</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    P1-&gt;&gt;Backend: UPDATE outbox published_at</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    P1-&gt;&gt;Obs: Metric: outbox_published++</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span></code></pre></div></div>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">### Pattern Routing and Backend Execution</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<p>graph LR
subgraph &quot;Pattern Layer&quot;
Input[Pattern Input<br>Context]</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    subgraph &quot;Pattern Decision Tree&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        CheckOutbox{Outbox&lt;br/&gt;Enabled?}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        CheckClaim{Claim Check&lt;br/&gt;Enabled?}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        CheckSize{Payload &gt; 1MB?}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        CheckCDC{CDC&lt;br/&gt;Enabled?}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Output[Pattern Output&lt;br/&gt;Context]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">subgraph &quot;Backend Router&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Route[Route by&lt;br/&gt;Backend Type]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    subgraph &quot;Execution Strategies&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Direct[Direct Execute]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Transact[Transactional&lt;br/&gt;Execute]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Stream[Streaming&lt;br/&gt;Execute]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Batch[Batch&lt;br/&gt;Execute]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">subgraph &quot;Backend Connectors&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    KafkaOps[Kafka Operations]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    PGOps[Postgres Operations]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    S3Ops[S3 Operations]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    RedisOps[Redis Operations]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Input --&gt; CheckOutbox</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CheckOutbox --&gt;|Yes| Transact</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CheckOutbox --&gt;|No| CheckClaim</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CheckClaim --&gt;|Yes| CheckSize</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CheckClaim --&gt;|No| CheckCDC</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CheckSize --&gt;|Yes| S3Ops</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CheckSize --&gt;|No| Output</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CheckCDC --&gt;|Yes| KafkaOps</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CheckCDC --&gt;|No| Output</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Output --&gt; Route</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Route --&gt;|Queue/PubSub| Direct</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Route --&gt;|Transact| Transact</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Route --&gt;|Reader| Stream</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Route --&gt;|Bulk Insert| Batch</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Direct --&gt; KafkaOps</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Transact --&gt; PGOps</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Stream --&gt; PGOps</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Batch --&gt; RedisOps</span><br></span></code></pre></div></div>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">### Three-Layer Model</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#### Layer 3: Client API (Abstraction)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">The **What** layer - defines the interface applications use:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<p>// Example: PubSub Service
service PubSubService {
rpc Publish(PublishRequest) returns (PublishResponse);
rpc Subscribe(SubscribeRequest) returns (stream Event);
}</p>
<p>message PublishRequest {
string topic = 1;
bytes payload = 2;  // Application doesn&#x27;t know about Claim Check
map&lt;string, string&gt; metadata = 3;
}</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">**Key Characteristics:**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- Backend-agnostic (no Kafka/NATS specific details)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- Pattern-agnostic (no Claim Check/Outbox details)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- Stable API (evolves slowly)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- Type-safe via protobuf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#### Layer 2: Pattern Composition (Strategy)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">The **How** layer - implements reliability patterns transparently:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<h1>Namespace configuration</h1>
<p>namespaces:</p>
<ul>
<li>
<p>name: video-processing</p>
<h1>Layer 3: Client sees PubSub API</h1>
<p>client_api: pubsub</p>
<h1>Layer 2: Composed patterns (order matters!)</h1>
<p>patterns:</p>
<ul>
<li>
<p>type: claim-check        # Pattern 1: Handle large payloads
threshold: 1MB
storage: s3
bucket: video-processing</p>
</li>
<li>
<p>type: outbox             # Pattern 2: Transactional guarantees
table: video_outbox
database: postgres</p>
</li>
</ul>
<h1>Layer 1: Backend execution</h1>
<p>backend:
queue: kafka
topic_prefix: video</p>
</li>
</ul>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">**Pattern Execution Order:**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<p>sequenceDiagram
participant App as Application
participant API as Layer 3: PubSub API
participant Pat1 as Layer 2: Claim Check
participant Pat2 as Layer 2: Outbox
participant Backend as Layer 1: Kafka</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">App-&gt;&gt;API: Publish(topic, 50MB payload)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">API-&gt;&gt;Pat1: Process (50MB &gt; 1MB threshold)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Pat1-&gt;&gt;Pat1: Store payload in S3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Pat1-&gt;&gt;Pat1: Replace payload with claim_check_id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Pat1-&gt;&gt;Pat2: Continue ({topic, claim_check_id})</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Pat2-&gt;&gt;Pat2: INSERT INTO video_outbox&lt;br/&gt;(topic, claim_check_id)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Pat2-&gt;&gt;Pat2: COMMIT transaction</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Pat2-&gt;&gt;Backend: Publish to Kafka&lt;br/&gt;(lightweight message)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Backend--&gt;&gt;Pat2: Acknowledged</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Pat2--&gt;&gt;API: Success</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">API--&gt;&gt;App: PublishResponse</span><br></span></code></pre></div></div>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#### Layer 1: Backend Execution (Implementation)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">The **Where** layer - connects to and executes on specific backends:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<p>// Backend-specific implementation
impl KafkaBackend {
async fn publish(&amp;self, topic: &amp;str, payload: &amp;[u8]) -&gt; Result<offset> {
self.producer
.send(topic, payload, None)
.await
.map_err(|e| Error::Backend(e))
}
}</offset></p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">**Key Characteristics:**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- Backend-specific logic encapsulated</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- Connection pooling and retries</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- Performance optimization per backend</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- Pluggable (new backends without API changes)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">## Pattern Composition</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">### Compatible Pattern Combinations</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Not all patterns can be layered together. Compatibility depends on:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- **Ordering**: Some patterns must come before others</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- **Data Flow**: Patterns must pass compatible data structures</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- **Semantics**: Patterns can&#x27;t contradict (e.g., eventual + strong consistency)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#### Composition Matrix</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| Base API | Compatible Patterns (In Order) | Example Use Case |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|----------|-------------------------------|------------------|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| **PubSub** | Claim Check → Kafka/NATS | Large payload pub/sub |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| **PubSub** | Outbox → Claim Check → Kafka | Transactional large payloads |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| **Queue** | Claim Check → Kafka | Large message queue |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| **Queue** | WAL → Tiered Storage | Fast writes + archival |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| **Reader** | Cache (Look-Aside) → Postgres | Frequent reads |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| **Reader** | CDC → Cache Invalidation | Fresh cached reads |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| **Transact** | Outbox → Queue Publisher | Transactional messaging |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| **Transact** | Event Sourcing → Materialized Views | Audit + performance |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">### Publisher with Claim Check Pattern</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">**Scenario**: Application needs to publish large video files (50MB-5GB) to a pub/sub system, but Kafka/NATS have 1-10MB message limits.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#### Without Layering (Application Code)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<h1>Application must implement Claim Check manually</h1>
<p>def publish_video(video_id, video_bytes):
if len(video_bytes) &gt; 1_000_000:  # &gt; 1MB
# Upload to S3
s3_key = f&quot;videos/{video_id}&quot;
s3.put_object(Bucket=&quot;videos&quot;, Key=s3_key, Body=video_bytes)</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    # Publish reference</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kafka.produce(&quot;videos&quot;, {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;video_id&quot;: video_id,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;s3_reference&quot;: s3_key,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;size&quot;: len(video_bytes)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    })</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # Publish inline</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kafka.produce(&quot;videos&quot;, {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;video_id&quot;: video_id,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;payload&quot;: video_bytes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    })</span><br></span></code></pre></div></div>
<h1>Consumer must implement Claim Check retrieval</h1>
<p>def consume_video():
msg = kafka.consume(&quot;videos&quot;)
if &quot;s3_reference&quot; in msg:
# Download from S3
video_bytes = s3.get_object(
Bucket=&quot;videos&quot;,
Key=msg[&quot;s3_reference&quot;]
)[&quot;Body&quot;].read()
else:
video_bytes = msg[&quot;payload&quot;]</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">process_video(video_bytes)</span><br></span></code></pre></div></div>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">**Problems**:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- 20+ lines of boilerplate per producer/consumer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- Must handle S3 credentials, retries, errors</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- No automatic cleanup of claim check objects</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- Different logic for small vs large payloads</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#### With Prism Layering (Zero Application Code)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">**Configuration**:</span><br></span></code></pre></div></div>
<p>namespaces:</p>
<ul>
<li>
<p>name: video-processing
client_api: pubsub</p>
<p>patterns:</p>
<ul>
<li>type: claim-check
threshold: 1MB
storage:
backend: s3
bucket: prism-claim-checks
prefix: videos/
cleanup:
strategy: on_consume
ttl: 604800  # 7 days fallback</li>
</ul>
<p>backend:
type: kafka
brokers: [kafka-1:9092, kafka-2:9092]
topic: videos</p>
</li>
</ul>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">**Application Code**:</span><br></span></code></pre></div></div>
<h1>Producer: Prism handles Claim Check automatically</h1>
<p>client.publish(&quot;videos&quot;, video_bytes)</p>
<h1>Prism:</h1>
<h1>1. Detects size &gt; 1MB</h1>
<h1>2. Uploads to S3: s3://prism-claim-checks/videos/{uuid}</h1>
<h1>3. Publishes Kafka: {claim_check_id, size, metadata}</h1>
<h1>Consumer: Prism reconstructs full payload</h1>
<p>event = client.subscribe(&quot;videos&quot;)
video_bytes = event.payload  # Prism fetched from S3 automatically
process_video(video_bytes)</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">**Benefits**:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- 2 lines of application code (vs 20+)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- Automatic threshold detection</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- Transparent S3 upload/download</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- Automatic cleanup after consumption</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- Same API for small and large payloads</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">### Outbox + Claim Check Layering</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">**Scenario**: Application needs **transactional guarantees** (outbox) AND **large payload handling** (claim check).</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#### Pattern Layering</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<p>sequenceDiagram
participant App as Application
participant Prism as Prism Proxy
participant DB as PostgreSQL
participant S3 as S3 Storage
participant Kafka as Kafka</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">App-&gt;&gt;Prism: Publish(topic, 100MB model weights)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Note over Prism: Layer 2: Claim Check Pattern</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Prism-&gt;&gt;Prism: Detect 100MB &gt; 1MB threshold</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Prism-&gt;&gt;S3: PUT ml-models/model-v2.bin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">S3--&gt;&gt;Prism: Success, S3 URL</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Note over Prism: Layer 2: Outbox Pattern</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Prism-&gt;&gt;DB: BEGIN TRANSACTION</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Prism-&gt;&gt;DB: INSERT INTO outbox&lt;br/&gt;(event_type, claim_check_id,&lt;br/&gt; metadata, payload_size)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Prism-&gt;&gt;DB: COMMIT TRANSACTION</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">DB--&gt;&gt;Prism: Transaction committed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Prism--&gt;&gt;App: PublishResponse (success)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Note over Prism: Background: Outbox Publisher</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">loop Every 100ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Prism-&gt;&gt;DB: SELECT * FROM outbox&lt;br/&gt;WHERE published_at IS NULL</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    DB--&gt;&gt;Prism: Unpublished events</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Prism-&gt;&gt;Kafka: Publish lightweight message&lt;br/&gt;{claim_check_id, metadata}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Kafka--&gt;&gt;Prism: Acknowledged</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Prism-&gt;&gt;DB: UPDATE outbox&lt;br/&gt;SET published_at = NOW()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span></code></pre></div></div>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">**Configuration**:</span><br></span></code></pre></div></div>
<p>namespaces:</p>
<ul>
<li>
<p>name: ml-model-releases
client_api: pubsub</p>
<p>patterns:</p>
<h1>Order matters: Outbox runs first (wraps everything in transaction)</h1>
<ul>
<li>type: outbox
database: postgres
table: ml_model_outbox
publisher:
interval: 100ms
batch_size: 100</li>
</ul>
<h1>Claim Check runs second (inside outbox transaction)</h1>
<ul>
<li>type: claim-check
threshold: 10MB
storage:
backend: s3
bucket: ml-models
prefix: releases/
metadata_field: claim_check_id  # Store S3 reference in outbox</li>
</ul>
<p>backend:
type: kafka
topic: model-releases</p>
</li>
</ul>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">**Guarantees**:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- ✅ If transaction commits, event WILL be published (outbox)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- ✅ If transaction fails, S3 object can be garbage collected</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- ✅ Large models don&#x27;t block database (claim check)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- ✅ Kafka receives lightweight messages (&amp;lt;1KB)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">### CDC + Cache Invalidation Layering</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">**Scenario**: Keep cache synchronized with database changes using CDC.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#### Pattern Composition</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<p>namespaces:</p>
<ul>
<li>
<p>name: user-profiles
client_api: reader</p>
<p>patterns:</p>
<h1>Pattern 1: Look-Aside Cache (fast reads)</h1>
<ul>
<li>type: cache
strategy: look-aside
backend: redis
ttl: 900  # 15 minutes
key_pattern: &quot;user:{id}:profile&quot;</li>
</ul>
<h1>Pattern 2: CDC for cache invalidation</h1>
<ul>
<li>
<p>type: cdc
source:
backend: postgres
database: users_db
table: user_profiles
sink:
backend: kafka
topic: user-profile-changes</p>
<h1>Consumers: Cache invalidator</h1>
<p>consumers:</p>
<ul>
<li>name: cache-invalidator
type: cache_invalidator
backend: redis
operations: [UPDATE, DELETE]
key_extractor: &quot;user:{after.id}:profile&quot;</li>
</ul>
</li>
</ul>
<p>backend:
type: postgres
database: users_db</p>
</li>
</ul>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">**Data Flow**:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<p>graph LR
App[Application]
Prism[Prism Proxy]
Cache[Redis Cache]
DB[(PostgreSQL)]
CDC[CDC Connector]
Kafka[Kafka]
Invalidator[Cache Invalidator]</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">App --&gt;|Read user profile| Prism</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Prism --&gt;|1. Check cache| Cache</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Cache -.-&gt;|Cache Hit| Prism</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Prism --&gt;|2. Query DB&lt;br/&gt;(on miss)| DB</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">DB -.-&gt;|User data| Prism</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Prism -.-&gt;|3. Populate cache| Cache</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">App2[Another App] --&gt;|Update profile| DB</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">DB --&gt;|WAL stream| CDC</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CDC --&gt;|Parse changes| Kafka</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Kafka --&gt;|Subscribe| Invalidator</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Invalidator --&gt;|DEL user:123:profile| Cache</span><br></span></code></pre></div></div>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">**Benefits**:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- Applications always read from cache (fast)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- Cache stays synchronized with database</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- No dual writes or race conditions</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- Automatic invalidation on UPDATE/DELETE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">## Separation of Concerns</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">### Client API vs Backend Strategy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#### Example: Queue Service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">**Client API (Layer 3)** - Stable interface:</span><br></span></code></pre></div></div>
<p>service QueueService {
rpc Publish(PublishRequest) returns (PublishResponse);
rpc Subscribe(SubscribeRequest) returns (stream Message);
}</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">**Backend Strategy (Layer 2 + 1)** - Implementation details:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| Strategy Combination | Backends | Use Case |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|---------------------|----------|----------|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| Queue (simple) | Kafka | Standard message queue |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| WAL + Queue | Kafka WAL → Postgres | Durable + queryable queue |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| Claim Check + Queue | S3 + Kafka | Large message queue |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| Outbox + Queue | Postgres outbox → Kafka | Transactional queue |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| Tiered Queue | Redis (hot) → Postgres (warm) → S3 (cold) | Multi-tier retention |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">**Application doesn&#x27;t know which strategy** - same API for all:</span><br></span></code></pre></div></div>
<h1>Works with ANY backend strategy</h1>
<p>client.publish(&quot;events&quot;, payload)
messages = client.subscribe(&quot;events&quot;)</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">### Pattern Configuration Encapsulation</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Applications declare requirements; Prism selects patterns:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<h1>Application-facing configuration</h1>
<p>namespaces:</p>
<ul>
<li>name: video-processing
needs:
message_size: 5GB              # Prism adds Claim Check
consistency: strong            # Prism adds Outbox
retention: 30 days             # Prism adds Tiered Storage
throughput: 10k msgs/s         # Prism sizes Kafka partitions</li>
</ul>
<h1>Prism generates internal config:</h1>
<p>namespaces:</p>
<ul>
<li>name: video-processing
client_api: pubsub
patterns:
<ul>
<li>type: outbox              # For consistency</li>
<li>type: claim-check         # For message_size</li>
<li>type: tiered-storage      # For retention
backend:
type: kafka
partitions: 20              # For throughput</li>
</ul>
</li>
</ul>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">## Stitching Patterns Together</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">### Pattern Interfaces</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Each pattern implements standard interfaces for composability:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<p>/// Pattern trait for composing reliability patterns
#[async_trait]
pub trait Pattern: Send + Sync {
/// Process outgoing data (before backend)
async fn process_publish(
&amp;self,
ctx: &amp;mut PublishContext,
) -&gt; Result&lt;()&gt;;</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/// Process incoming data (after backend)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">async fn process_consume(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &amp;self,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ctx: &amp;mut ConsumeContext,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">) -&gt; Result&lt;()&gt;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/// Pattern metadata</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fn metadata(&amp;self) -&gt; PatternMetadata;</span><br></span></code></pre></div></div>
<p>}</p>
<p>pub struct PublishContext {
pub topic: String,
pub payload: Vec<u8>,
pub metadata: HashMap&lt;String, String&gt;,
pub backend: BackendType,
}</u8></p>
<p>pub struct ConsumeContext {
pub message_id: String,
pub payload: Vec<u8>,
pub metadata: HashMap&lt;String, String&gt;,
}</u8></p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">### Example: Claim Check Pattern Implementation</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<p>pub struct ClaimCheckPattern {
threshold: usize,
storage: Arc<dyn objectstorage="">,
}</dyn></p>
<p>#[async_trait]
impl Pattern for ClaimCheckPattern {
async fn process_publish(&amp;self, ctx: &amp;mut PublishContext) -&gt; Result&lt;()&gt; {
// Check threshold
if ctx.payload.len() &gt; self.threshold {
// Store in object storage
let claim_check_id = Uuid::new_v4().to_string();
let key = format!(&quot;claim-checks/{}&quot;, claim_check_id);</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">        self.storage.put(&amp;key, &amp;ctx.payload).await?;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Replace payload with reference</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ctx.metadata.insert(&quot;claim_check_id&quot;.to_string(), claim_check_id);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ctx.metadata.insert(&quot;payload_size&quot;.to_string(), ctx.payload.len().to_string());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ctx.payload = vec![];  // Empty payload, reference in metadata</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Ok(())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">async fn process_consume(&amp;self, ctx: &amp;mut ConsumeContext) -&gt; Result&lt;()&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Check for claim check reference</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if let Some(claim_check_id) = ctx.metadata.get(&quot;claim_check_id&quot;) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        let key = format!(&quot;claim-checks/{}&quot;, claim_check_id);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Fetch from object storage</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ctx.payload = self.storage.get(&amp;key).await?;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Optional: Delete claim check after consumption</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // self.storage.delete(&amp;key).await?;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Ok(())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fn metadata(&amp;self) -&gt; PatternMetadata {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    PatternMetadata {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        name: &quot;claim-check&quot;.to_string(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        version: &quot;1.0.0&quot;.to_string(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        compatible_backends: vec![BackendType::Kafka, BackendType::Nats],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>}</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">### Pattern Chain Execution</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Prism executes patterns in order:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<p>pub struct PatternChain {
patterns: Vec&lt;Box<dyn pattern="">&gt;,
}</dyn></p>
<p>impl PatternChain {
pub async fn process_publish(&amp;self, mut ctx: PublishContext) -&gt; Result<publishcontext> {
// Execute patterns in order
for pattern in &amp;self.patterns {
pattern.process_publish(&amp;mut ctx).await?;
}
Ok(ctx)
}</publishcontext></p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">pub async fn process_consume(&amp;self, mut ctx: ConsumeContext) -&gt; Result&lt;ConsumeContext&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Execute patterns in reverse order for consume</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for pattern in self.patterns.iter().rev() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pattern.process_consume(&amp;mut ctx).await?;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Ok(ctx)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>}</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">**Example execution with Outbox + Claim Check**:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Publish Flow:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  App → [Layer 3: PubSub API]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    → [Layer 2: Outbox Pattern] (begin transaction)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      → [Layer 2: Claim Check Pattern] (store large payload)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        → [Layer 1: Kafka Backend] (publish lightweight message)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ← (commit transaction)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ← (return success)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ← PublishResponse</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Consume Flow:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  [Layer 1: Kafka Backend] (receive message)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    → [Layer 2: Claim Check Pattern] (fetch from S3)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      → [Layer 2: Outbox Pattern] (no-op for consume)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        → [Layer 3: PubSub API]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          → App (full payload reconstructed)</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="building-on-existing-rfcs">Building on Existing RFCs<a href="#building-on-existing-rfcs" class="hash-link" aria-label="Direct link to Building on Existing RFCs" title="Direct link to Building on Existing RFCs" translate="no">​</a></h2>
<p>This RFC builds on and connects:</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="rfc-001-prism-architecture">RFC-001: Prism Architecture<a href="#rfc-001-prism-architecture" class="hash-link" aria-label="Direct link to RFC-001: Prism Architecture" title="Direct link to RFC-001: Prism Architecture" translate="no">​</a></h3>
<ul>
<li><strong>Layer 3 Client API</strong> maps to RFC-001 &quot;Interface Layers&quot; (Queue, PubSub, Reader, Transact)</li>
<li><strong>Layer 1 Backend Execution</strong> maps to RFC-001 &quot;Container Plugin Model&quot;</li>
<li><strong>Layer 2 Pattern Composition</strong> is NEW - enables powerful combinations</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="rfc-002-data-layer-interface">RFC-002: Data Layer Interface<a href="#rfc-002-data-layer-interface" class="hash-link" aria-label="Direct link to RFC-002: Data Layer Interface" title="Direct link to RFC-002: Data Layer Interface" translate="no">​</a></h3>
<ul>
<li>Client-facing protobuf APIs defined in RFC-002</li>
<li>Applications use stable APIs from RFC-002</li>
<li>Patterns (Layer 2) transparently implement RFC-002 interfaces</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="rfc-007-cache-strategies">RFC-007: Cache Strategies<a href="#rfc-007-cache-strategies" class="hash-link" aria-label="Direct link to RFC-007: Cache Strategies" title="Direct link to RFC-007: Cache Strategies" translate="no">​</a></h3>
<ul>
<li>Look-Aside and Write-Through caching are <strong>patterns</strong> (Layer 2)</li>
<li>Can compose with other patterns (e.g., CDC + Cache Invalidation)</li>
<li>Cache configuration moves from application to namespace config</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="rfc-009-distributed-reliability-patterns">RFC-009: Distributed Reliability Patterns<a href="#rfc-009-distributed-reliability-patterns" class="hash-link" aria-label="Direct link to RFC-009: Distributed Reliability Patterns" title="Direct link to RFC-009: Distributed Reliability Patterns" translate="no">​</a></h3>
<ul>
<li>All 7 patterns (Claim Check, Outbox, WAL, CDC, Tiered Storage, Event Sourcing, CQRS) live in Layer 2</li>
<li>Can be composed as shown in RFC-009 &quot;Pattern Composition and Layering&quot; section</li>
<li>This RFC formalizes the layering architecture</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="rfc-010-admin-protocol-with-oidc">RFC-010: Admin Protocol with OIDC<a href="#rfc-010-admin-protocol-with-oidc" class="hash-link" aria-label="Direct link to RFC-010: Admin Protocol with OIDC" title="Direct link to RFC-010: Admin Protocol with OIDC" translate="no">​</a></h3>
<ul>
<li>Admin API operates at Layer 3 (control plane, not data plane)</li>
<li>Patterns configured via admin API</li>
<li>Observability of pattern health exposed via admin API</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="rfc-011-data-proxy-authentication">RFC-011: Data Proxy Authentication<a href="#rfc-011-data-proxy-authentication" class="hash-link" aria-label="Direct link to RFC-011: Data Proxy Authentication" title="Direct link to RFC-011: Data Proxy Authentication" translate="no">​</a></h3>
<ul>
<li>Authentication happens at Layer 3 (before patterns)</li>
<li>Patterns inherit session context</li>
<li>Backend credentials managed at Layer 1</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="configuration-schema">Configuration Schema<a href="#configuration-schema" class="hash-link" aria-label="Direct link to Configuration Schema" title="Direct link to Configuration Schema" translate="no">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="namespace-pattern-configuration">Namespace Pattern Configuration<a href="#namespace-pattern-configuration" class="hash-link" aria-label="Direct link to Namespace Pattern Configuration" title="Direct link to Namespace Pattern Configuration" translate="no">​</a></h3>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">namespaces:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - name: video-processing</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # Layer 3: Client API</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    client_api: pubsub</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # Layer 2: Pattern composition (ordered!)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    patterns:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - type: outbox</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        enabled: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        config:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          database: postgres</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          table: video_outbox</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          publisher:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            interval: 100ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            batch_size: 100</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - type: claim-check</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        enabled: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        config:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          threshold: 1MB</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          storage:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            backend: s3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            bucket: prism-claim-checks</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            prefix: videos/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          compression: gzip</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          cleanup:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            strategy: on_consume</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ttl: 604800</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - type: tiered-storage</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        enabled: false  # Optional pattern</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # Layer 1: Backend configuration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    backend:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      type: kafka</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      brokers: [kafka-1:9092, kafka-2:9092]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      topic: videos</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      partitions: 10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      replication: 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # Observability</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    observability:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      trace_patterns: true  # Trace each pattern execution</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      pattern_metrics: true</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="pattern-validation">Pattern Validation<a href="#pattern-validation" class="hash-link" aria-label="Direct link to Pattern Validation" title="Direct link to Pattern Validation" translate="no">​</a></h3>
<p>Prism validates pattern compatibility at namespace creation:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">pub fn validate_pattern_chain(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    api: ClientApi,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    patterns: &amp;[PatternConfig],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    backend: &amp;BackendConfig,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">) -&gt; Result&lt;()&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Check API compatibility</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for pattern in patterns {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if !pattern.supports_api(&amp;api) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return Err(Error::IncompatiblePattern {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                pattern: pattern.type_name(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                api: api.name(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Check pattern ordering</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for window in patterns.windows(2) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if !window[1].compatible_with(&amp;window[0]) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return Err(Error::IncompatiblePatternOrder {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                first: window[0].type_name(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                second: window[1].type_name(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Check backend compatibility</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if !backend.supports_patterns(patterns) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return Err(Error::BackendIncompatibleWithPatterns);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Ok(())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="testing-strategy">Testing Strategy<a href="#testing-strategy" class="hash-link" aria-label="Direct link to Testing Strategy" title="Direct link to Testing Strategy" translate="no">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="unit-tests-individual-patterns">Unit Tests: Individual Patterns<a href="#unit-tests-individual-patterns" class="hash-link" aria-label="Direct link to Unit Tests: Individual Patterns" title="Direct link to Unit Tests: Individual Patterns" translate="no">​</a></h3>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#[tokio::test]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">async fn test_claim_check_pattern_threshold() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    let storage = Arc::new(MockObjectStorage::new());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    let pattern = ClaimCheckPattern {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        threshold: 1_000_000,  // 1MB</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        storage: storage.clone(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Small payload - should not trigger claim check</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    let mut ctx = PublishContext {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        topic: &quot;test&quot;.to_string(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        payload: vec![0u8; 500_000],  // 500KB</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ..Default::default()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pattern.process_publish(&amp;mut ctx).await.unwrap();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    assert!(!ctx.metadata.contains_key(&quot;claim_check_id&quot;));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    assert_eq!(ctx.payload.len(), 500_000);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Large payload - should trigger claim check</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    let mut ctx = PublishContext {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        topic: &quot;test&quot;.to_string(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        payload: vec![0u8; 2_000_000],  // 2MB</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ..Default::default()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pattern.process_publish(&amp;mut ctx).await.unwrap();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    assert!(ctx.metadata.contains_key(&quot;claim_check_id&quot;));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    assert_eq!(ctx.payload.len(), 0);  // Payload replaced</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    assert_eq!(storage.object_count(), 1);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="integration-tests-pattern-chains">Integration Tests: Pattern Chains<a href="#integration-tests-pattern-chains" class="hash-link" aria-label="Direct link to Integration Tests: Pattern Chains" title="Direct link to Integration Tests: Pattern Chains" translate="no">​</a></h3>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#[tokio::test]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">async fn test_outbox_claim_check_chain() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    let db = setup_test_db().await;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    let s3 = setup_test_s3().await;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    let kafka = setup_test_kafka().await;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    let chain = PatternChain::new(vec![</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Box::new(OutboxPattern::new(db.clone())),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Box::new(ClaimCheckPattern::new(1_000_000, s3.clone())),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ]);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Publish large payload</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    let ctx = PublishContext {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        topic: &quot;test&quot;.to_string(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        payload: vec![0u8; 5_000_000],  // 5MB</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ..Default::default()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    let ctx = chain.process_publish(ctx).await.unwrap();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Verify outbox entry created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    let outbox_entries = db.query(&quot;SELECT * FROM outbox WHERE published_at IS NULL&quot;).await.unwrap();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    assert_eq!(outbox_entries.len(), 1);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Verify S3 object stored</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    assert_eq!(s3.object_count(), 1);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Verify Kafka message is lightweight</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    assert!(ctx.metadata.contains_key(&quot;claim_check_id&quot;));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    assert_eq!(ctx.payload.len(), 0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="end-to-end-tests">End-to-End Tests<a href="#end-to-end-tests" class="hash-link" aria-label="Direct link to End-to-End Tests" title="Direct link to End-to-End Tests" translate="no">​</a></h3>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">def test_e2e_large_payload_pubsub():</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # Setup Prism with Outbox + Claim Check</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    prism = PrismTestServer(config={</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;namespace&quot;: &quot;test&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;client_api&quot;: &quot;pubsub&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;patterns&quot;: [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            {&quot;type&quot;: &quot;outbox&quot;, &quot;database&quot;: &quot;postgres&quot;},</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            {&quot;type&quot;: &quot;claim-check&quot;, &quot;threshold&quot;: &quot;1MB&quot;, &quot;storage&quot;: &quot;s3&quot;}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;backend&quot;: {&quot;type&quot;: &quot;kafka&quot;}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    })</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    client = prism.client()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # Publish 10MB payload</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    large_payload = b&quot;x&quot; * 10_000_000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    response = client.publish(&quot;test-topic&quot;, large_payload)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    assert response.success</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # Consume and verify full payload reconstructed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    subscriber = client.subscribe(&quot;test-topic&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    event = next(subscriber)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    assert event.payload == large_payload</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    # Verify S3 object cleaned up after consumption</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    assert prism.s3.object_count() == 0</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="performance-characteristics">Performance Characteristics<a href="#performance-characteristics" class="hash-link" aria-label="Direct link to Performance Characteristics" title="Direct link to Performance Characteristics" translate="no">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="pattern-overhead">Pattern Overhead<a href="#pattern-overhead" class="hash-link" aria-label="Direct link to Pattern Overhead" title="Direct link to Pattern Overhead" translate="no">​</a></h3>















































<table><thead><tr><th>Pattern</th><th>Latency Added</th><th>Memory Overhead</th><th>Use When</th></tr></thead><tbody><tr><td><strong>None</strong></td><td>0ms</td><td>0MB</td><td>Simple use cases</td></tr><tr><td><strong>Claim Check</strong></td><td>+10-50ms (S3 upload)</td><td>~10MB (buffer)</td><td>Payload &gt; 1MB</td></tr><tr><td><strong>Outbox</strong></td><td>+5-10ms (DB write)</td><td>~1MB (buffer)</td><td>Need transactions</td></tr><tr><td><strong>CDC</strong></td><td>Background</td><td>~5MB (replication)</td><td>Keep systems synced</td></tr><tr><td><strong>Tiered Storage</strong></td><td>Variable</td><td>~10MB (tier metadata)</td><td>Hot/warm/cold data</td></tr><tr><td><strong>WAL</strong></td><td>+2-5ms (log append)</td><td>~50MB (WAL buffer)</td><td>High write throughput</td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="example-outbox--claim-check-performance">Example: Outbox + Claim Check Performance<a href="#example-outbox--claim-check-performance" class="hash-link" aria-label="Direct link to Example: Outbox + Claim Check Performance" title="Direct link to Example: Outbox + Claim Check Performance" translate="no">​</a></h3>
<p><strong>Baseline (no patterns)</strong>: 10ms P99 latency, 10k RPS</p>
<p><strong>With Outbox + Claim Check</strong>:</p>
<ul>
<li>Small payloads (&lt;1MB): 15ms P99 (+5ms for outbox), 8k RPS</li>
<li>Large payloads (&gt;1MB): 60ms P99 (+50ms for S3 upload), 1k RPS</li>
</ul>
<p><strong>Trade-off</strong>: Slightly higher latency for <strong>strong guarantees</strong> (transactional + large payload support).</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="migration-strategy">Migration Strategy<a href="#migration-strategy" class="hash-link" aria-label="Direct link to Migration Strategy" title="Direct link to Migration Strategy" translate="no">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="phase-1-single-pattern-low-risk">Phase 1: Single Pattern (Low Risk)<a href="#phase-1-single-pattern-low-risk" class="hash-link" aria-label="Direct link to Phase 1: Single Pattern (Low Risk)" title="Direct link to Phase 1: Single Pattern (Low Risk)" translate="no">​</a></h3>
<p>Start with one pattern per namespace:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># Before: Direct Kafka</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">backend: kafka</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># After: Add Claim Check only</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">patterns:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - type: claim-check</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    threshold: 1MB</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">backend: kafka</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="phase-2-compose-two-patterns-medium-risk">Phase 2: Compose Two Patterns (Medium Risk)<a href="#phase-2-compose-two-patterns-medium-risk" class="hash-link" aria-label="Direct link to Phase 2: Compose Two Patterns (Medium Risk)" title="Direct link to Phase 2: Compose Two Patterns (Medium Risk)" translate="no">​</a></h3>
<p>Add second compatible pattern:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">patterns:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - type: outbox         # Transactional guarantees</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - type: claim-check    # Large payload handling</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">backend: kafka</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="phase-3-complex-composition-higher-risk">Phase 3: Complex Composition (Higher Risk)<a href="#phase-3-complex-composition-higher-risk" class="hash-link" aria-label="Direct link to Phase 3: Complex Composition (Higher Risk)" title="Direct link to Phase 3: Complex Composition (Higher Risk)" translate="no">​</a></h3>
<p>Layer 3+ patterns for advanced use cases:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">patterns:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - type: outbox</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - type: claim-check</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - type: tiered-storage  # Archive old messages to S3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - type: cdc             # Replicate to analytics DB</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">backend: kafka</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="observability">Observability<a href="#observability" class="hash-link" aria-label="Direct link to Observability" title="Direct link to Observability" translate="no">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="pattern-metrics">Pattern Metrics<a href="#pattern-metrics" class="hash-link" aria-label="Direct link to Pattern Metrics" title="Direct link to Pattern Metrics" translate="no">​</a></h3>
<h1>Claim Check</h1>
<p>prism_pattern_claim_check_stored_total{namespace=&quot;videos&quot;} 1234
prism_pattern_claim_check_retrieved_total{namespace=&quot;videos&quot;} 1230
prism_pattern_claim_check_storage_bytes{namespace=&quot;videos&quot;} 5.2e9
prism_pattern_claim_check_cleanup_success{namespace=&quot;videos&quot;} 1230</p>
<h1>Outbox</h1>
<p>prism_pattern_outbox_inserted_total{namespace=&quot;videos&quot;} 1234
prism_pattern_outbox_published_total{namespace=&quot;videos&quot;} 1234
prism_pattern_outbox_lag_seconds{namespace=&quot;videos&quot;} 0.15
prism_pattern_outbox_pending_count{namespace=&quot;videos&quot;} 5</p>
<h1>Pattern Chain</h1>
<p>prism_pattern_chain_duration_seconds{namespace=&quot;videos&quot;, pattern=&quot;claim-check&quot;} 0.042
prism_pattern_chain_duration_seconds{namespace=&quot;videos&quot;, pattern=&quot;outbox&quot;} 0.008</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">### Distributed Tracing</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Trace: Publish large video</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├─ Span: PubSubService.Publish [12ms]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  ├─ Span: OutboxPattern.process_publish [8ms]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │  ├─ Span: db.begin_transaction [1ms]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │  ├─ Span: ClaimCheckPattern.process_publish [45ms]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │  │  ├─ Span: s3.put_object [42ms]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │  │  └─ Span: generate_claim_check_id [0.1ms]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │  ├─ Span: db.insert_outbox [2ms]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │  └─ Span: db.commit_transaction [1ms]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  └─ Span: kafka.produce [3ms]</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="references">References<a href="#references" class="hash-link" aria-label="Direct link to References" title="Direct link to References" translate="no">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="related-rfcs">Related RFCs<a href="#related-rfcs" class="hash-link" aria-label="Direct link to Related RFCs" title="Direct link to Related RFCs" translate="no">​</a></h3>
<ul>
<li>RFC-001: Prism Architecture - Defines interface layers</li>
<li>RFC-002: Data Layer Interface - Client API specifications</li>
<li>RFC-007: Cache Strategies - Cache as a pattern</li>
<li>RFC-009: Distributed Reliability Patterns - Individual patterns</li>
<li>RFC-010: Admin Protocol with OIDC - Pattern configuration</li>
<li>RFC-011: Data Proxy Authentication - Authentication layer</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="external-references">External References<a href="#external-references" class="hash-link" aria-label="Direct link to External References" title="Direct link to External References" translate="no">​</a></h3>
<ul>
<li><a href="https://www.enterpriseintegrationpatterns.com/" target="_blank" rel="noopener noreferrer">Enterprise Integration Patterns</a></li>
<li><a href="https://www.enterpriseintegrationpatterns.com/patterns/messaging/StoreInLibrary.html" target="_blank" rel="noopener noreferrer">Claim Check Pattern</a></li>
<li><a href="https://microservices.io/patterns/data/transactional-outbox.html" target="_blank" rel="noopener noreferrer">Transactional Outbox</a></li>
<li><a href="https://en.wikipedia.org/wiki/Decorator_pattern" target="_blank" rel="noopener noreferrer">Decorator Pattern</a> - Inspiration for pattern composition</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="adrs">ADRs<a href="#adrs" class="hash-link" aria-label="Direct link to ADRs" title="Direct link to ADRs" translate="no">​</a></h3>
<ul>
<li>ADR-024: Layered Interface Hierarchy</li>
<li>ADR-025: Container Plugin Model</li>
<li>ADR-034: Product/Feature Sharding Strategy</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="open-questions">Open Questions<a href="#open-questions" class="hash-link" aria-label="Direct link to Open Questions" title="Direct link to Open Questions" translate="no">​</a></h2>
<ol>
<li><strong>Pattern Hot-Reload</strong>: Can patterns be added/removed without restarting proxy?</li>
<li><strong>Pattern Configuration Evolution</strong>: How to update pattern config for existing namespaces?</li>
<li><strong>Pattern Performance Profiling</strong>: Which patterns add most latency in production?</li>
<li><strong>Custom Patterns</strong>: Can users define custom patterns via plugins?</li>
<li><strong>Pattern Versioning</strong>: How to version patterns independently of proxy?</li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="revision-history">Revision History<a href="#revision-history" class="hash-link" aria-label="Direct link to Revision History" title="Direct link to Revision History" translate="no">​</a></h2>
<ul>
<li>2025-10-09: Initial draft defining layered data access patterns, pattern composition, and separation of client API from backend strategies</li>
</ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-tags-row"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/prism-data-layer/rfc/tags/architecture">architecture</a></li><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/prism-data-layer/rfc/tags/patterns">patterns</a></li><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/prism-data-layer/rfc/tags/composition">composition</a></li><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/prism-data-layer/rfc/tags/data-access">data-access</a></li><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/prism-data-layer/rfc/tags/layering">layering</a></li></ul></div></div><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/jrepp/prism-data-layer/tree/main/docs-cms/../docs-cms/rfcs/rfc-014-layered-data-access-patterns.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/prism-data-layer/rfc/rfc-013"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Neptune Graph Backend Implementation • RFC-013</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/prism-data-layer/rfc/rfc-015"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Plugin Acceptance Test Framework (Interface-Based Testing) • RFC-015</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#abstract" class="table-of-contents__link toc-highlight">Abstract</a></li><li><a href="#motivation" class="table-of-contents__link toc-highlight">Motivation</a><ul><li><a href="#pattern-2-large-payload-pubsub-claim-check" class="table-of-contents__link toc-highlight">Pattern 2: Large Payload Pub/Sub (Claim Check)</a></li><li><a href="#pattern-4-change-data-capture-with-kafka-cdc--outbox" class="table-of-contents__link toc-highlight">Pattern 4: Change Data Capture with Kafka (CDC + Outbox)</a></li><li><a href="#pattern-6-cached-reads-with-auto-invalidation-cache--cdc" class="table-of-contents__link toc-highlight">Pattern 6: Cached Reads with Auto-Invalidation (Cache + CDC)</a></li></ul></li><li><a href="#building-on-existing-rfcs" class="table-of-contents__link toc-highlight">Building on Existing RFCs</a><ul><li><a href="#rfc-001-prism-architecture" class="table-of-contents__link toc-highlight">RFC-001: Prism Architecture</a></li><li><a href="#rfc-002-data-layer-interface" class="table-of-contents__link toc-highlight">RFC-002: Data Layer Interface</a></li><li><a href="#rfc-007-cache-strategies" class="table-of-contents__link toc-highlight">RFC-007: Cache Strategies</a></li><li><a href="#rfc-009-distributed-reliability-patterns" class="table-of-contents__link toc-highlight">RFC-009: Distributed Reliability Patterns</a></li><li><a href="#rfc-010-admin-protocol-with-oidc" class="table-of-contents__link toc-highlight">RFC-010: Admin Protocol with OIDC</a></li><li><a href="#rfc-011-data-proxy-authentication" class="table-of-contents__link toc-highlight">RFC-011: Data Proxy Authentication</a></li></ul></li><li><a href="#configuration-schema" class="table-of-contents__link toc-highlight">Configuration Schema</a><ul><li><a href="#namespace-pattern-configuration" class="table-of-contents__link toc-highlight">Namespace Pattern Configuration</a></li><li><a href="#pattern-validation" class="table-of-contents__link toc-highlight">Pattern Validation</a></li></ul></li><li><a href="#testing-strategy" class="table-of-contents__link toc-highlight">Testing Strategy</a><ul><li><a href="#unit-tests-individual-patterns" class="table-of-contents__link toc-highlight">Unit Tests: Individual Patterns</a></li><li><a href="#integration-tests-pattern-chains" class="table-of-contents__link toc-highlight">Integration Tests: Pattern Chains</a></li><li><a href="#end-to-end-tests" class="table-of-contents__link toc-highlight">End-to-End Tests</a></li></ul></li><li><a href="#performance-characteristics" class="table-of-contents__link toc-highlight">Performance Characteristics</a><ul><li><a href="#pattern-overhead" class="table-of-contents__link toc-highlight">Pattern Overhead</a></li><li><a href="#example-outbox--claim-check-performance" class="table-of-contents__link toc-highlight">Example: Outbox + Claim Check Performance</a></li></ul></li><li><a href="#migration-strategy" class="table-of-contents__link toc-highlight">Migration Strategy</a><ul><li><a href="#phase-1-single-pattern-low-risk" class="table-of-contents__link toc-highlight">Phase 1: Single Pattern (Low Risk)</a></li><li><a href="#phase-2-compose-two-patterns-medium-risk" class="table-of-contents__link toc-highlight">Phase 2: Compose Two Patterns (Medium Risk)</a></li><li><a href="#phase-3-complex-composition-higher-risk" class="table-of-contents__link toc-highlight">Phase 3: Complex Composition (Higher Risk)</a></li></ul></li><li><a href="#observability" class="table-of-contents__link toc-highlight">Observability</a><ul><li><a href="#pattern-metrics" class="table-of-contents__link toc-highlight">Pattern Metrics</a></li></ul></li><li><a href="#references" class="table-of-contents__link toc-highlight">References</a><ul><li><a href="#related-rfcs" class="table-of-contents__link toc-highlight">Related RFCs</a></li><li><a href="#external-references" class="table-of-contents__link toc-highlight">External References</a></li><li><a href="#adrs" class="table-of-contents__link toc-highlight">ADRs</a></li></ul></li><li><a href="#open-questions" class="table-of-contents__link toc-highlight">Open Questions</a></li><li><a href="#revision-history" class="table-of-contents__link toc-highlight">Revision History</a></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Documentation</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/prism-data-layer/docs/intro">Overview</a></li><li class="footer__item"><a class="footer__link-item" href="/prism-data-layer/docs/changelog">Change Log</a></li><li class="footer__item"><a class="footer__link-item" href="/prism-data-layer/adr">ADRs</a></li><li class="footer__item"><a class="footer__link-item" href="/prism-data-layer/rfc">RFCs</a></li><li class="footer__item"><a class="footer__link-item" href="/prism-data-layer/memos">Memos</a></li><li class="footer__item"><a class="footer__link-item" href="/prism-data-layer/prds">PRDs</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Project</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/jrepp/prism-data-layer" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright"><div>Copyright © 2025 Prism. Built with Docusaurus.</div><div style="margin-top:0.5rem;font-size:0.875rem;opacity:0.8"><span>Version <!-- -->d884409</span><span> • </span><span>Built <!-- -->Oct 14, 2025, 09:46 AM PDT</span><span> • </span><span>Commit <!-- -->d884409</span></div></div></div></div></footer></div>
</body>
</html>