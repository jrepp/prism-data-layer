<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-rfc docs-version-current docs-doc-page docs-doc-id-rfc-011" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.9.1">
<title data-rh="true">Data Proxy Authentication (Input/Output) | Prism</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://jrepp.github.io/prism-data-layer/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://jrepp.github.io/prism-data-layer/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://jrepp.github.io/prism-data-layer/rfc/rfc-011"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-rfc-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-rfc-current"><meta data-rh="true" property="og:title" content="Data Proxy Authentication (Input/Output) | Prism"><meta data-rh="true" name="description" content="Abstract"><meta data-rh="true" property="og:description" content="Abstract"><link data-rh="true" rel="icon" href="/prism-data-layer/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://jrepp.github.io/prism-data-layer/rfc/rfc-011"><link data-rh="true" rel="alternate" href="https://jrepp.github.io/prism-data-layer/rfc/rfc-011" hreflang="en"><link data-rh="true" rel="alternate" href="https://jrepp.github.io/prism-data-layer/rfc/rfc-011" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Data Proxy Authentication (Input/Output) • RFC-011","item":"https://jrepp.github.io/prism-data-layer/rfc/rfc-011"}]}</script><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,user-scalable=yes">
<meta name="theme-color" content="#6366f1">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><link rel="stylesheet" href="/prism-data-layer/assets/css/styles.73adf43b.css">
<script src="/prism-data-layer/assets/js/runtime~main.553f3957.js" defer="defer"></script>
<script src="/prism-data-layer/assets/js/main.b135ba04.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",t||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")),document.documentElement.setAttribute("data-theme-choice",t||"system")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/prism-data-layer/"><div class="navbar__logo"><img src="/prism-data-layer/img/prism-logo-transparent-background.png" alt="Prism Data Gateway Logo" class="themedComponent_mlkZ themedComponent--light_NVdE" height="32" width="32"><img src="/prism-data-layer/img/prism-logo-transparent-background.png" alt="Prism Data Gateway Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU" height="32" width="32"></div><b class="navbar__title text--truncate">Prism</b></a><a class="navbar__item navbar__link" href="/prism-data-layer/docs/intro">Overview</a><a class="navbar__item navbar__link" href="/prism-data-layer/docs/changelog">Change Log</a><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Documentation</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/prism-data-layer/adr">ADRs (Architecture Decision Records)</a></li><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/prism-data-layer/rfc">RFCs (Request for Comments)</a></li><li><a class="dropdown__link" href="/prism-data-layer/memos">Memos (Technical Analysis)</a></li><li><a class="dropdown__link" href="/prism-data-layer/prds">PRDs (Product Requirements)</a></li></ul></div></div><div class="navbar__items navbar__items--right"><div class="buildInfo_asc2"><span class="version_ADrX" title="Build: 12230f2">12230f2</span><span class="separator_VfCt">•</span><span class="buildTime_n1Nn" title="Last updated: Oct 14, 10:32 AM PDT">Oct 14, 10:32 AM PDT</span></div><div class="navbar__item"><a href="https://github.com/jrepp/prism-data-layer/actions/workflows/docs.yml" target="_blank" rel="noopener noreferrer" title="GitHub Pages" style="display: flex; align-items: center; padding: 0 0.5rem;"><img src="https://github.com/jrepp/prism-data-layer/actions/workflows/docs.yml/badge.svg" alt="Build" style="margin: 0;"></a></div><a href="https://github.com/jrepp/prism-data-layer" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle_vylO colorModeToggle_x44X"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><div class="navbar__search searchBarContainer_NW3z" dir="ltr"><input placeholder="Search" aria-label="Search" class="navbar__search-input searchInput_YFbd" value=""><div class="loadingRing_RJI3 searchBarLoadingRing_YnHq"><div></div><div></div><div></div><div></div></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/prism-data-layer/rfc/"><span title="Request for Comments (RFCs)" class="linkLabel_WmDU">Request for Comments (RFCs)</span></a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/prism-data-layer/rfc/rfc-001"><span title="RFC-001 to 010" class="categoryLinkLabel_W154">RFC-001 to 010</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" href="/prism-data-layer/rfc/rfc-011"><span title="RFC-011 to 020" class="categoryLinkLabel_W154">RFC-011 to 020</span></a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/prism-data-layer/rfc/rfc-011"><span title="Data Proxy Authentication (Input/Output) • RFC-011" class="linkLabel_WmDU">Data Proxy Authentication (Input/Output) • RFC-011</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/prism-data-layer/rfc/rfc-012"><span title="Prism Network Gateway (prism-netgw) - Multi-Region Control Plane • RFC-012" class="linkLabel_WmDU">Prism Network Gateway (prism-netgw) - Multi-Region Control Plane • RFC-012</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/prism-data-layer/rfc/rfc-013"><span title="Neptune Graph Backend Implementation • RFC-013" class="linkLabel_WmDU">Neptune Graph Backend Implementation • RFC-013</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/prism-data-layer/rfc/rfc-014"><span title="Layered Data Access Patterns • RFC-014" class="linkLabel_WmDU">Layered Data Access Patterns • RFC-014</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/prism-data-layer/rfc/rfc-015"><span title="Plugin Acceptance Test Framework (Interface-Based Testing) • RFC-015" class="linkLabel_WmDU">Plugin Acceptance Test Framework (Interface-Based Testing) • RFC-015</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/prism-data-layer/rfc/rfc-016"><span title="Local Development Infrastructure • RFC-016" class="linkLabel_WmDU">Local Development Infrastructure • RFC-016</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/prism-data-layer/rfc/rfc-017"><span title="Multicast Registry Pattern • RFC-017" class="linkLabel_WmDU">Multicast Registry Pattern • RFC-017</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/prism-data-layer/rfc/rfc-018"><span title="POC Implementation Strategy • RFC-018" class="linkLabel_WmDU">POC Implementation Strategy • RFC-018</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/prism-data-layer/rfc/rfc-019"><span title="Pattern SDK Authorization Layer - Token Validation and Policy Enforcement • RFC-019" class="linkLabel_WmDU">Pattern SDK Authorization Layer - Token Validation and Policy Enforcement • RFC-019</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/prism-data-layer/rfc/rfc-020"><span title="Streaming HTTP Listener - API-Specific Adapter Pattern • RFC-020" class="linkLabel_WmDU">Streaming HTTP Listener - API-Specific Adapter Pattern • RFC-020</span></a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/prism-data-layer/rfc/rfc-021"><span title="RFC-021 to 030" class="categoryLinkLabel_W154">RFC-021 to 030</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/prism-data-layer/rfc/rfc-031"><span title="RFC-031 to 040" class="categoryLinkLabel_W154">RFC-031 to 040</span></a></div></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_z5aJ"><div class="docItemContainer_c0TR"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/prism-data-layer/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">RFC-011 to 020</span></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">Data Proxy Authentication (Input/Output) • RFC-011</span></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="docMetadata_NQcq"><div class="tagsRow_ipDH"><span class="tag_VbXK">authentication</span><span class="tag_VbXK">mtls</span><span class="tag_VbXK">proxy</span><span class="tag_VbXK">backends</span><span class="tag_VbXK">security</span></div><div class="metadataRow_PvZM"><span class="metadataItem_RMFE info_Qo8L"><strong>Status:</strong> <!-- -->Proposed</span><span class="metadataItem_RMFE"><strong>Author:</strong> <!-- -->Platform Team</span><span class="metadataItem_RMFE"><strong>Created:</strong> <!-- -->Oct 8, 2025</span><span class="metadataItem_RMFE"><strong>Updated:</strong> <!-- -->Oct 8, 2025</span></div></div><div class="theme-doc-markdown markdown"><header><h1>Data Proxy Authentication (Input/Output)</h1></header><h2 class="anchor anchorWithStickyNavbar_LWe7" id="abstract">Abstract<a href="#abstract" class="hash-link" aria-label="Direct link to Abstract" title="Direct link to Abstract" translate="no">​</a></h2>
<p>This RFC specifies the complete authentication model for Prism&#x27;s data proxy, covering both <strong>input authentication</strong> (how clients authenticate to the proxy) and <strong>output authentication</strong> (how the proxy authenticates to backend data stores). The design emphasizes mTLS for service-to-service communication, certificate management, and secure backend connectivity.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="motivation">Motivation<a href="#motivation" class="hash-link" aria-label="Direct link to Motivation" title="Direct link to Motivation" translate="no">​</a></h2>
<p>The Prism data proxy sits between client applications and heterogeneous backends, requiring:</p>
<p><strong>Input Authentication (Client → Proxy):</strong></p>
<ul>
<li>Verify client service identity</li>
<li>Prevent unauthorized access to data plane</li>
<li>Support namespace-level access control</li>
<li>Provide audit trail of data access</li>
</ul>
<p><strong>Output Authentication (Proxy → Backend):</strong></p>
<ul>
<li>Authenticate proxy to backend services</li>
<li>Manage credentials for multiple backend types</li>
<li>Support credential rotation without downtime</li>
<li>Isolate backend credentials from clients</li>
</ul>
<p><strong>Goals:</strong></p>
<ul>
<li>Define mTLS-based client authentication</li>
<li>Specify backend authentication patterns per backend type</li>
<li>Document credential management and rotation</li>
<li>Provide sequence diagrams for all authentication flows</li>
</ul>
<p><strong>Non-Goals:</strong></p>
<ul>
<li>Admin API authentication (covered in RFC-010)</li>
<li>Application user authentication (application responsibility)</li>
<li>Data encryption at rest (backend responsibility)</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="architecture-overview">Architecture Overview<a href="#architecture-overview" class="hash-link" aria-label="Direct link to Architecture Overview" title="Direct link to Architecture Overview" translate="no">​</a></h2>
<p>┌──────────────────────────────────────────────────────────────────┐
│                      Authentication Boundaries                   │
└──────────────────────────────────────────────────────────────────┘</p>
<p>Client Service → [mTLS] → Prism Proxy → [Backend Auth] → Backends
(Input Auth)              (Identity)    (Output Auth)</p>
<p>Input:  mTLS certificates validate client identity
Output: Backend-specific credentials (mTLS, passwords, API keys)</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">### Ports and Security Zones</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">┌─────────────────────────────────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                        Security Zones                           │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└─────────────────────────────────────────────────────────────────┘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Zone 1: Client Services (Service Mesh)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - mTLS enforced</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - Certificates issued by company CA</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - Short-lived (24 hours)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Zone 2: Prism Proxy (DMZ)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - Accepts mTLS from clients</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - Holds backend credentials</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - Enforces namespace ACLs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Zone 3: Backend Services (Secure Network)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - Postgres: mTLS or password</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - Kafka: SASL/SCRAM or mTLS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - NATS: JWT or mTLS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - Redis: ACL + password</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="input-authentication-client--proxy">Input Authentication (Client → Proxy)<a href="#input-authentication-client--proxy" class="hash-link" aria-label="Direct link to Input Authentication (Client → Proxy)" title="Direct link to Input Authentication (Client → Proxy)" translate="no">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="mtls-certificate-based-authentication">mTLS Certificate-Based Authentication<a href="#mtls-certificate-based-authentication" class="hash-link" aria-label="Direct link to mTLS Certificate-Based Authentication" title="Direct link to mTLS Certificate-Based Authentication" translate="no">​</a></h3>
<!-- -->
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="certificate-structure">Certificate Structure<a href="#certificate-structure" class="hash-link" aria-label="Direct link to Certificate Structure" title="Direct link to Certificate Structure" translate="no">​</a></h3>
<p>Client certificates must include:</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">Subject</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">CN</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> user</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">api.prod.us</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">east</span><span class="token punctuation" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># Service name + env + region</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">O</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Company Name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">OU</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Platform Services</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">Subject Alternative Names</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">DNS</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> user</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">api.prod.us</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">east</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">1.internal</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">DNS</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> user</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">api.prod.svc.cluster.local</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">URI</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> spiffe</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//company.com/ns/prod/sa/user</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">api</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">Extensions</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">Key Usage</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Digital Signature</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Key Encipherment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">Extended Key Usage</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Client Authentication</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">Validity</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 24 hours</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="rust-implementation">Rust Implementation<a href="#rust-implementation" class="hash-link" aria-label="Direct link to Rust Implementation" title="Direct link to Rust Implementation" translate="no">​</a></h3>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">use</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">rustls</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">::</span><span class="token punctuation" style="color:#393A34">{</span><span class="token class-name">ServerConfig</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">ClientCertVerifier</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">Certificate</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">use</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">x509_parser</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">::</span><span class="token namespace" style="opacity:0.7">prelude</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">::</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token type-definition class-name">PrismClientVerifier</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ca_cert</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">Certificate</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">impl</span><span class="token plain"> </span><span class="token class-name">ClientCertVerifier</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token class-name">PrismClientVerifier</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">verify_client_cert</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        cert_chain</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token punctuation" style="color:#393A34">[</span><span class="token class-name">Certificate</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        _sni</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">Option</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token keyword" style="color:#00009f">str</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token class-name">Result</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">ClientCertVerified</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">TLSError</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> cert_chain</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">is_empty</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token class-name">Err</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">TLSError</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">NoCertificatesPresented</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> client_cert </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">cert_chain</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// Verify signature chain</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">verify_cert_chain</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">client_cert</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ca_cert</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">?</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// Check expiry</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> parsed</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">X509Certificate</span><span class="token punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">from_der</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">client_cert</span><span class="token number" style="color:#36acaa">.0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">map_err</span><span class="token punctuation" style="color:#393A34">(</span><span class="token closure-params closure-punctuation punctuation" style="color:#393A34">|</span><span class="token closure-params">_</span><span class="token closure-params closure-punctuation punctuation" style="color:#393A34">|</span><span class="token plain"> </span><span class="token class-name">TLSError</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">InvalidCertificateData</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;Failed to parse&quot;</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">into</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">?</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!</span><span class="token plain">parsed</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">validity</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">is_valid</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token class-name">Err</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">TLSError</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">InvalidCertificateData</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;Expired&quot;</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">into</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">Ok</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">ClientCertVerified</span><span class="token punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">assertion</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token type-definition class-name">ServiceIdentity</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> service_name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> environment</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> region</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">impl</span><span class="token plain"> </span><span class="token class-name">ServiceIdentity</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">from_certificate</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">cert</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token class-name">Certificate</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token class-name">Result</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">Self</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> parsed</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">X509Certificate</span><span class="token punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">from_der</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">cert</span><span class="token number" style="color:#36acaa">.0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">?</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// Extract CN from subject</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> cn </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> parsed</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">subject</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">iter_common_name</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">next</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">and_then</span><span class="token punctuation" style="color:#393A34">(</span><span class="token closure-params closure-punctuation punctuation" style="color:#393A34">|</span><span class="token closure-params">cn</span><span class="token closure-params closure-punctuation punctuation" style="color:#393A34">|</span><span class="token plain"> cn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">as_str</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ok</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ok_or</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Error</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">MissingCommonName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">?</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// Parse: user-api.prod.us-east-1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> parts</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">Vec</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token keyword" style="color:#00009f">str</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> cn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">split</span><span class="token punctuation" style="color:#393A34">(</span><span class="token char">&#x27;.&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">collect</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> parts</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token class-name">Err</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Error</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">InvalidCommonName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">Ok</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">ServiceIdentity</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            service_name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> parts</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">to_string</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            environment</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> parts</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">unwrap_or</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token string" style="color:#e3116c">&quot;unknown&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">to_string</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            region</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> parts</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">unwrap_or</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token string" style="color:#e3116c">&quot;unknown&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">to_string</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="request-flow-with-mtls">Request Flow with mTLS<a href="#request-flow-with-mtls" class="hash-link" aria-label="Direct link to Request Flow with mTLS" title="Direct link to Request Flow with mTLS" translate="no">​</a></h3>
<!-- -->
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="certificate-rotation">Certificate Rotation<a href="#certificate-rotation" class="hash-link" aria-label="Direct link to Certificate Rotation" title="Direct link to Certificate Rotation" translate="no">​</a></h3>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">use</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">notify</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">::</span><span class="token punctuation" style="color:#393A34">{</span><span class="token class-name">Watcher</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">RecursiveMode</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token type-definition class-name">CertificateReloader</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cert_path</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">PathBuf</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    key_path</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">PathBuf</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    server_config</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">Arc</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">RwLock</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">ServerConfig</span><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">impl</span><span class="token plain"> </span><span class="token class-name">CertificateReloader</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">watch</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token class-name">Result</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">tx</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> rx</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">mpsc</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">::</span><span class="token function" style="color:#d73a49">channel</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">mut</span><span class="token plain"> watcher </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">notify</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">::</span><span class="token function" style="color:#d73a49">watcher</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">tx</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">Duration</span><span class="token punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">from_secs</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">30</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">?</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        watcher</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">watch</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cert_path</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">RecursiveMode</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">NonRecursive</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">?</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        watcher</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">watch</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">key_path</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">RecursiveMode</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">NonRecursive</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">?</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">loop</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">match</span><span class="token plain"> rx</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">recv</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token class-name">Ok</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">DebouncedEvent</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">Write</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token class-name">DebouncedEvent</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">Create</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token namespace" style="opacity:0.7">tracing</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">::</span><span class="token macro property" style="color:#36acaa">info!</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;Certificate files changed, reloading...&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> new_config </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">load_server_config</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">await</span><span class="token operator" style="color:#393A34">?</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">mut</span><span class="token plain"> config </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">server_config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">write</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">await</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">config </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> new_config</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token namespace" style="opacity:0.7">tracing</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">::</span><span class="token macro property" style="color:#36acaa">info!</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;Certificate reloaded successfully&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                _ </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="output-authentication-proxy--backend">Output Authentication (Proxy → Backend)<a href="#output-authentication-proxy--backend" class="hash-link" aria-label="Direct link to Output Authentication (Proxy → Backend)" title="Direct link to Output Authentication (Proxy → Backend)" translate="no">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="per-backend-authentication-strategies">Per-Backend Authentication Strategies<a href="#per-backend-authentication-strategies" class="hash-link" aria-label="Direct link to Per-Backend Authentication Strategies" title="Direct link to Per-Backend Authentication Strategies" translate="no">​</a></h3>
<p>┌─────────────────────────────────────────────────────────────────┐
│                 Backend Authentication Matrix                   │
└─────────────────────────────────────────────────────  ────────────┘</p>















































<table><thead><tr><th>Backend</th><th>Primary Auth</th><th>Fallback</th><th>Credential Store</th></tr></thead><tbody><tr><td>Postgres</td><td>mTLS</td><td>Password</td><td>Vault/K8s Secret</td></tr><tr><td>Kafka</td><td>SASL/SCRAM</td><td>mTLS</td><td>Vault/K8s Secret</td></tr><tr><td>NATS</td><td>JWT</td><td>NKey</td><td>Vault/K8s Secret</td></tr><tr><td>Redis</td><td>ACL + Password</td><td>None</td><td>Vault/K8s Secret</td></tr><tr><td>SQLite</td><td>File permissions</td><td>None</td><td>N/A (local)</td></tr><tr><td>S3</td><td>IAM Role</td><td>Access Keys</td><td>Instance Profile</td></tr></tbody></table>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">### Postgres Authentication</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<p>sequenceDiagram
participant Proxy as Prism Proxy
participant Vault as HashiCorp Vault
participant PG as PostgreSQL</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Note over Proxy,PG: Initial Connection</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Proxy-&gt;&gt;Vault: Request credentials&lt;br/&gt;GET /v1/database/creds/postgres-main</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Vault-&gt;&gt;Vault: Generate dynamic credentials&lt;br/&gt;User: prism-prod-abc123&lt;br/&gt;Password: &lt;random&gt;&lt;br/&gt;TTL: 1 hour</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Vault-&gt;&gt;PG: CREATE ROLE prism-prod-abc123&lt;br/&gt;WITH LOGIN PASSWORD &#x27;...&#x27;&lt;br/&gt;VALID UNTIL &#x27;2025-10-09 15:00&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Vault--&gt;&gt;Proxy: {username, password, lease_id}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Proxy-&gt;&gt;Proxy: Cache credentials&lt;br/&gt;Set lease renewal timer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Note over Proxy,PG: Data Operations</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Proxy-&gt;&gt;PG: Connect&lt;br/&gt;SSL mode: require&lt;br/&gt;User: prism-prod-abc123&lt;br/&gt;Password: &lt;from vault&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PG-&gt;&gt;PG: Verify credentials</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PG--&gt;&gt;Proxy: Connection established</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Proxy-&gt;&gt;PG: SELECT * FROM user_profiles&lt;br/&gt;WHERE id = &#x27;user:123&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PG--&gt;&gt;Proxy: Row data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Note over Proxy,PG: Credential Renewal</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">loop Every 30 minutes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Proxy-&gt;&gt;Vault: Renew lease&lt;br/&gt;PUT /v1/sys/leases/renew&lt;br/&gt;{lease_id}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Vault--&gt;&gt;Proxy: Lease extended</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Note over Proxy,PG: Credential Expiry</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">alt Lease expires</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Vault-&gt;&gt;PG: REVOKE ROLE prism-prod-abc123</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Proxy-&gt;&gt;Vault: Request new credentials</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Vault--&gt;&gt;Proxy: New {username, password}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Proxy-&gt;&gt;Proxy: Update connection pool</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span></code></pre></div></div>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">### Kafka Authentication (SASL/SCRAM)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<p>sequenceDiagram
participant Proxy as Prism Proxy
participant Vault as HashiCorp Vault
participant Kafka as Kafka Broker</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Note over Proxy,Kafka: Bootstrap</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Proxy-&gt;&gt;Vault: GET /v1/kafka/creds/producer-main</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Vault-&gt;&gt;Vault: Generate SCRAM credentials&lt;br/&gt;User: prism-kafka-xyz789&lt;br/&gt;Password: &lt;scram-sha-512&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Vault-&gt;&gt;Kafka: kafka-configs --alter&lt;br/&gt;--entity-type users&lt;br/&gt;--entity-name prism-kafka-xyz789&lt;br/&gt;--add-config &#x27;SCRAM-SHA-512=[...]&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Vault--&gt;&gt;Proxy: {username, password, mechanism: SCRAM-SHA-512}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Proxy-&gt;&gt;Kafka: SASL Handshake&lt;br/&gt;Mechanism: SCRAM-SHA-512</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Kafka--&gt;&gt;Proxy: SASL Challenge</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Proxy-&gt;&gt;Kafka: SASL Response&lt;br/&gt;{username, scrambled_password}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Kafka-&gt;&gt;Kafka: Verify SCRAM</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Kafka--&gt;&gt;Proxy: Authenticated</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Note over Proxy,Kafka: Produce Messages</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Proxy-&gt;&gt;Kafka: ProduceRequest&lt;br/&gt;Topic: user-events</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Kafka-&gt;&gt;Kafka: Check ACLs:&lt;br/&gt;Can prism-kafka-xyz789 write to topic?</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Kafka--&gt;&gt;Proxy: ProduceResponse</span><br></span></code></pre></div></div>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">### NATS Authentication (JWT)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<p>sequenceDiagram
participant Proxy as Prism Proxy
participant Vault as HashiCorp Vault
participant NATS as NATS Server</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Proxy-&gt;&gt;Vault: GET /v1/nats/creds/publisher</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Vault-&gt;&gt;Vault: Generate JWT + NKey&lt;br/&gt;Claims: {&lt;br/&gt;  pub: [&quot;events.&gt;&quot;],&lt;br/&gt;  sub: [&quot;responses.prism.&gt;&quot;]&lt;br/&gt;}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Vault--&gt;&gt;Proxy: {jwt, seed (nkey)}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Proxy-&gt;&gt;NATS: CONNECT {&lt;br/&gt;  jwt: &quot;eyJhbG...&quot;,&lt;br/&gt;  sig: sign(nonce, nkey)&lt;br/&gt;}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NATS-&gt;&gt;NATS: Verify JWT signature&lt;br/&gt;Check expiry&lt;br/&gt;Validate claims</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NATS--&gt;&gt;Proxy: +OK</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Proxy-&gt;&gt;NATS: PUB events.user.login 42&lt;br/&gt;{user_id: &quot;123&quot;, timestamp: ...}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NATS-&gt;&gt;NATS: Check permissions:&lt;br/&gt;Can JWT publish to events.user.login?</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NATS--&gt;&gt;Proxy: +OK</span><br></span></code></pre></div></div>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">### Redis Authentication (ACL)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<p>sequenceDiagram
participant Proxy as Prism Proxy
participant Vault as HashiCorp Vault
participant Redis as Redis Server</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Proxy-&gt;&gt;Vault: GET /v1/redis/creds/cache-rw</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Vault-&gt;&gt;Vault: Generate Redis ACL&lt;br/&gt;User: prism-cache-abc&lt;br/&gt;Password: &lt;random&gt;&lt;br/&gt;ACL: ~cache:* +get +set +del</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Vault-&gt;&gt;Redis: ACL SETUSER prism-cache-abc&lt;br/&gt;on &gt;password ~cache:* +get +set +del</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Vault--&gt;&gt;Proxy: {username, password}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Proxy-&gt;&gt;Redis: AUTH prism-cache-abc &lt;password&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Redis-&gt;&gt;Redis: Verify password&lt;br/&gt;Load ACL rules</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Redis--&gt;&gt;Proxy: OK</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Proxy-&gt;&gt;Redis: GET cache:user:123:profile</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Redis-&gt;&gt;Redis: Check ACL:&lt;br/&gt;Pattern match: cache:*&lt;br/&gt;Command allowed: GET</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Redis--&gt;&gt;Proxy: &quot;{&quot;name&quot;:&quot;Alice&quot;,...}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Proxy-&gt;&gt;Redis: SET cache:user:123:session &lt;data&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Redis--&gt;&gt;Proxy: OK</span><br></span></code></pre></div></div>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">### Credential Management</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<p>use vaultrs::client::VaultClient;
use vaultrs::kv2;</p>
<p>pub struct BackendCredentials {
pub backend_type: String,
pub username: String,
pub password: String,
pub lease_id: Option<string>,
pub expires_at: DateTime<utc>,
}</utc></string></p>
<p>pub struct CredentialManager {
vault_client: VaultClient,
credentials: Arc&lt;RwLock&lt;HashMap&lt;String, BackendCredentials&gt;&gt;&gt;,
}</p>
<p>impl CredentialManager {
pub async fn get_credentials(&amp;self, backend_id: &amp;str) -&gt; Result<backendcredentials> {
// Check cache
{
let creds = self.credentials.read().await;
if let Some(cached) = creds.get(backend_id) {
if cached.expires_at &gt; Utc::now() + Duration::minutes(5) {
return Ok(cached.clone());
}
}
}</backendcredentials></p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    // Fetch from Vault</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    let path = format!(&quot;database/creds/{}&quot;, backend_id);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    let creds: VaultCredentials = self.vault_client</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .read(&amp;path)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .await?;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    let backend_creds = BackendCredentials {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        backend_type: creds.backend_type,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        username: creds.username,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        password: creds.password,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        lease_id: Some(creds.lease_id),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        expires_at: Utc::now() + Duration::hours(1),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Update cache</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        let mut cache = self.credentials.write().await;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        cache.insert(backend_id.to_string(), backend_creds.clone());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Schedule renewal</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    self.schedule_renewal(backend_id, &amp;creds.lease_id).await;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Ok(backend_creds)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">async fn schedule_renewal(&amp;self, backend_id: &amp;str, lease_id: &amp;str) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    let vault_client = self.vault_client.clone();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    let lease_id = lease_id.to_string();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    tokio::spawn(async move {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        loop {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            tokio::time::sleep(Duration::minutes(30)).await;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            match vault_client.renew_lease(&amp;lease_id).await {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                Ok(_) =&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    tracing::info!(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        backend_id = %backend_id,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        lease_id = %lease_id,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        &quot;Renewed backend credentials&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                Err(e) =&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    tracing::error!(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        backend_id = %backend_id,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        error = %e,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        &quot;Failed to renew credentials, will fetch new ones&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>}</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">## End-to-End Authentication Flow</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<p>sequenceDiagram
participant App as Application
participant Proxy as Prism Proxy
participant Vault as Vault
participant PG as Postgres
participant Audit as Audit Log</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Note over App,Audit: Complete Request Flow</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">App-&gt;&gt;Proxy: mTLS Handshake&lt;br/&gt;Present client cert</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Proxy-&gt;&gt;Proxy: Verify client cert&lt;br/&gt;Extract identity: user-api.prod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">App-&gt;&gt;Proxy: Get(namespace=&quot;users&quot;, id=&quot;123&quot;, key=&quot;profile&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Proxy-&gt;&gt;Proxy: Authorize:&lt;br/&gt;user-api.prod → users namespace?</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">alt Authorized</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Proxy-&gt;&gt;Proxy: Lookup backend:&lt;br/&gt;users → postgres-main</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Proxy-&gt;&gt;Proxy: Get credentials from cache</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    alt Credentials expired/missing</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Proxy-&gt;&gt;Vault: GET /database/creds/postgres-main</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Vault--&gt;&gt;Proxy: {username, password, lease_id}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Proxy-&gt;&gt;Proxy: Cache credentials</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Proxy-&gt;&gt;PG: Connect with credentials</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    PG--&gt;&gt;Proxy: Connection OK</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Proxy-&gt;&gt;PG: SELECT value FROM users&lt;br/&gt;WHERE id=&#x27;123&#x27; AND key=&#x27;profile&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    PG--&gt;&gt;Proxy: Row data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Proxy-&gt;&gt;Audit: Log:&lt;br/&gt;{service: user-api.prod,&lt;br/&gt; namespace: users,&lt;br/&gt; operation: get,&lt;br/&gt; backend: postgres-main,&lt;br/&gt; latency_ms: 2.3,&lt;br/&gt; result: success}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Proxy--&gt;&gt;App: GetResponse{value}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">else Not authorized</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Proxy-&gt;&gt;Audit: Log:&lt;br/&gt;{service: user-api.prod,&lt;br/&gt; namespace: users,&lt;br/&gt; operation: get,&lt;br/&gt; result: denied,&lt;br/&gt; reason: &quot;no permissions&quot;}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Proxy--&gt;&gt;App: PermissionDenied (7)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span></code></pre></div></div>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">## Secrets Provider Abstraction</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">To support multiple secret management services (Vault, AWS Secrets Manager, Google Secret Manager, Azure Key Vault), Prism implements a pluggable secrets provider architecture.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">### Secrets Provider Interface</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<p>#[async_trait]
pub trait SecretsProvider: Send + Sync {
/// Fetch credentials for a backend
async fn get_credentials(&amp;self, path: &amp;str) -&gt; Result<credentials>;</credentials></p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/// Renew a credential lease (if supported)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">async fn renew_credentials(&amp;self, lease_id: &amp;str) -&gt; Result&lt;()&gt;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/// Check if provider supports dynamic credentials</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fn supports_dynamic_credentials(&amp;self) -&gt; bool;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/// Get provider metadata</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fn provider_type(&amp;self) -&gt; &amp;str;</span><br></span></code></pre></div></div>
<p>}</p>
<p>pub struct Credentials {
pub username: Option<string>,
pub password: Option<string>,
pub api_key: Option<string>,
pub certificate: Option<string>,
pub private_key: Option<string>,
pub jwt_token: Option<string>,
pub metadata: HashMap&lt;String, String&gt;,
pub lease_id: Option<string>,
pub expires_at: Option&lt;DateTime<utc>&gt;,
}</utc></string></string></string></string></string></string></string></p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">### Provider Implementations</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#### HashiCorp Vault Provider</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<p>use vaultrs::client::VaultClient;</p>
<p>pub struct VaultProvider {
client: VaultClient,
namespace: Option<string>,
}</string></p>
<p>#[async_trait]
impl SecretsProvider for VaultProvider {
async fn get_credentials(&amp;self, path: &amp;str) -&gt; Result<credentials> {
let response: VaultCredResponse = self.client
.read(path)
.await?;</credentials></p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    Ok(Credentials {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        username: Some(response.data.username),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        password: Some(response.data.password),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        lease_id: Some(response.lease_id),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        expires_at: Some(Utc::now() + Duration::seconds(response.lease_duration)),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        metadata: response.metadata,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ..Default::default()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    })</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">async fn renew_credentials(&amp;self, lease_id: &amp;str) -&gt; Result&lt;()&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    self.client.renew_lease(lease_id).await?;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Ok(())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fn supports_dynamic_credentials(&amp;self) -&gt; bool {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    true  // Vault supports dynamic credential generation</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fn provider_type(&amp;self) -&gt; &amp;str {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;vault&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>}</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#### AWS Secrets Manager Provider</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<p>use aws_sdk_secretsmanager::Client as SecretsManagerClient;
use aws_sdk_secretsmanager::types::SecretString;</p>
<p>pub struct AwsSecretsProvider {
client: SecretsManagerClient,
region: String,
}</p>
<p>#[async_trait]
impl SecretsProvider for AwsSecretsProvider {
async fn get_credentials(&amp;self, path: &amp;str) -&gt; Result<credentials> {
// path format: &quot;arn:aws:secretsmanager:region:account:secret:name&quot;
// or simple: &quot;prism/postgres-main&quot;
let response = self.client
.get_secret_value()
.secret_id(path)
.send()
.await?;</credentials></p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    let secret_string = response.secret_string()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .ok_or(Error::MissingSecretValue)?;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Parse JSON secret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    let secret_data: SecretData = serde_json::from_str(secret_string)?;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Ok(Credentials {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        username: secret_data.username,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        password: secret_data.password,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        api_key: secret_data.api_key,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        expires_at: None,  // AWS Secrets Manager doesn&#x27;t auto-expire</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        metadata: secret_data.metadata.unwrap_or_default(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ..Default::default()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    })</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">async fn renew_credentials(&amp;self, _lease_id: &amp;str) -&gt; Result&lt;()&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // AWS Secrets Manager doesn&#x27;t support dynamic credential renewal</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Ok(())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fn supports_dynamic_credentials(&amp;self) -&gt; bool {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    false  // Static secrets only</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fn provider_type(&amp;self) -&gt; &amp;str {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;aws-secrets-manager&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>}</p>
<p>#[derive(Deserialize)]
struct SecretData {
username: Option<string>,
password: Option<string>,
api_key: Option<string>,
metadata: Option&lt;HashMap&lt;String, String&gt;&gt;,
}</string></string></string></p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#### Google Secret Manager Provider</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<p>use google_secretmanager::v1::SecretManagerServiceClient;</p>
<p>pub struct GcpSecretsProvider {
client: SecretManagerServiceClient,
project_id: String,
}</p>
<p>#[async_trait]
impl SecretsProvider for GcpSecretsProvider {
async fn get_credentials(&amp;self, path: &amp;str) -&gt; Result<credentials> {
// path format: &quot;projects/{project}/secrets/{secret}/versions/latest&quot;
// or simple: &quot;prism-postgres-main&quot; (auto-expanded)
let name = if path.starts_with(&quot;projects/&quot;) {
path.to_string()
} else {
format!(&quot;projects/{}/secrets/{}/versions/latest&quot;,
self.project_id, path)
};</credentials></p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    let response = self.client</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .access_secret_version(&amp;name)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .await?;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    let payload = response.payload</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .ok_or(Error::MissingPayload)?;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    let secret_string = String::from_utf8(payload.data)?;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    let secret_data: SecretData = serde_json::from_str(&amp;secret_string)?;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Ok(Credentials {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        username: secret_data.username,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        password: secret_data.password,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        api_key: secret_data.api_key,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        expires_at: None,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        metadata: secret_data.metadata.unwrap_or_default(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ..Default::default()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    })</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">async fn renew_credentials(&amp;self, _lease_id: &amp;str) -&gt; Result&lt;()&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // GCP Secret Manager doesn&#x27;t support dynamic renewal</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Ok(())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fn supports_dynamic_credentials(&amp;self) -&gt; bool {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fn provider_type(&amp;self) -&gt; &amp;str {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;gcp-secret-manager&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>}</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#### Azure Key Vault Provider</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<p>use azure_security_keyvault::KeyvaultClient;
use azure_identity::DefaultAzureCredential;</p>
<p>pub struct AzureKeyVaultProvider {
client: KeyvaultClient,
vault_url: String,
}</p>
<p>#[async_trait]
impl SecretsProvider for AzureKeyVaultProvider {
async fn get_credentials(&amp;self, path: &amp;str) -&gt; Result<credentials> {
// path format: &quot;prism-postgres-main&quot;
let response = self.client
.get_secret(&amp;self.vault_url, path)
.await?;</credentials></p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    let secret_value = response.value()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .ok_or(Error::MissingSecretValue)?;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    let secret_data: SecretData = serde_json::from_str(secret_value)?;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Ok(Credentials {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        username: secret_data.username,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        password: secret_data.password,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        api_key: secret_data.api_key,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        expires_at: response.attributes().expires_on(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        metadata: secret_data.metadata.unwrap_or_default(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ..Default::default()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    })</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">async fn renew_credentials(&amp;self, _lease_id: &amp;str) -&gt; Result&lt;()&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Azure Key Vault doesn&#x27;t support dynamic renewal</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Ok(())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fn supports_dynamic_credentials(&amp;self) -&gt; bool {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fn provider_type(&amp;self) -&gt; &amp;str {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;azure-keyvault&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>}</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">### Provider Comparison</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| Feature | Vault | AWS Secrets | GCP Secret | Azure Key Vault |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|---------|-------|-------------|------------|-----------------|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| **Dynamic Credentials** | ✅ Yes | ❌ No | ❌ No | ❌ No |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| **Auto-Rotation** | ✅ Yes (TTL) | ⚠️ Manual | ⚠️ Manual | ⚠️ Manual |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| **Versioning** | ✅ Yes | ✅ Yes | ✅ Yes | ✅ Yes |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| **Audit Logging** | ✅ Yes | ✅ CloudTrail | ✅ Cloud Audit | ✅ Monitor Logs |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| **IAM Integration** | ⚠️ Policies | ✅ Native IAM | ✅ Native IAM | ✅ Native RBAC |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| **Multi-Cloud** | ✅ Yes | ❌ AWS Only | ❌ GCP Only | ❌ Azure Only |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| **Self-Hosted** | ✅ Yes | ❌ No | ❌ No | ❌ No |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| **Cost** | Free (OSS) | $0.40/secret/month | $0.06/10k accesses | ~$0.03/10k ops |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">### Provider Selection Strategy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<p>pub enum ProviderConfig {
Vault {
address: String,
token_path: String,
namespace: Option<string>,
},
AwsSecretsManager {
region: String,
role_arn: Option<string>,
},
GcpSecretManager {
project_id: String,
service_account: Option<string>,
},
AzureKeyVault {
vault_url: String,
tenant_id: String,
client_id: Option<string>,
},
}</string></string></string></string></p>
<p>pub fn create_provider(config: &amp;ProviderConfig) -&gt; Result&lt;Arc<dyn secretsprovider="">&gt; {
match config {
ProviderConfig::Vault { address, token_path, namespace } =&gt; {
let token = std::fs::read_to_string(token_path)?;
let client = VaultClient::new(address, &amp;token, namespace.as_deref())?;
Ok(Arc::new(VaultProvider { client, namespace: namespace.clone() }))
}
ProviderConfig::AwsSecretsManager { region, role_arn } =&gt; {
let aws_config = aws_config::from_env()
.region(region)
.load()
.await;
let client = SecretsManagerClient::new(&amp;aws_config);
Ok(Arc::new(AwsSecretsProvider { client, region: region.clone() }))
}
ProviderConfig::GcpSecretManager { project_id, service_account } =&gt; {
let client = SecretManagerServiceClient::new().await?;
Ok(Arc::new(GcpSecretsProvider { client, project_id: project_id.clone() }))
}
ProviderConfig::AzureKeyVault { vault_url, tenant_id, client_id } =&gt; {
let credential = DefaultAzureCredential::new()?;
let client = KeyvaultClient::new(vault_url, credential)?;
Ok(Arc::new(AzureKeyVaultProvider { client, vault_url: vault_url.clone() }))
}
}
}</dyn></p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">### Credential Manager with Multiple Providers</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<p>pub struct CredentialManager {
provider: Arc<dyn secretsprovider="">,
credentials: Arc&lt;RwLock&lt;HashMap&lt;String, BackendCredentials&gt;&gt;&gt;,
refresh_interval: Duration,
}</dyn></p>
<p>impl CredentialManager {
pub fn new(provider: Arc<dyn secretsprovider="">) -&gt; Self {
Self {
provider,
credentials: Arc::new(RwLock::new(HashMap::new())),
refresh_interval: Duration::minutes(30),
}
}</dyn></p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">pub async fn get_credentials(&amp;self, backend_id: &amp;str, path: &amp;str) -&gt; Result&lt;BackendCredentials&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Check cache</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        let cache = self.credentials.read().await;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if let Some(cached) = cache.get(backend_id) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // For static providers, use longer cache TTL</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            let cache_valid = if self.provider.supports_dynamic_credentials() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                cached.expires_at &gt; Utc::now() + Duration::minutes(5)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                cached.expires_at &gt; Utc::now()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if cache_valid {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return Ok(cached.clone());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Fetch from provider</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    let creds = self.provider.get_credentials(path).await?;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    let backend_creds = BackendCredentials {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        backend_type: backend_id.to_string(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        username: creds.username.unwrap_or_default(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        password: creds.password.unwrap_or_default(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        api_key: creds.api_key,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        certificate: creds.certificate,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        lease_id: creds.lease_id.clone(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        expires_at: creds.expires_at.unwrap_or_else(|| {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // For static providers, cache for 24 hours</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Utc::now() + Duration::hours(24)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Update cache</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        let mut cache = self.credentials.write().await;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        cache.insert(backend_id.to_string(), backend_creds.clone());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Schedule renewal if provider supports dynamic credentials</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if self.provider.supports_dynamic_credentials() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if let Some(lease_id) = &amp;creds.lease_id {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self.schedule_renewal(backend_id, lease_id).await;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Ok(backend_creds)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">async fn schedule_renewal(&amp;self, backend_id: &amp;str, lease_id: &amp;str) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    let provider = self.provider.clone();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    let lease_id = lease_id.to_string();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    let backend_id = backend_id.to_string();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    let interval = self.refresh_interval;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    tokio::spawn(async move {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        loop {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            tokio::time::sleep(interval).await;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            match provider.renew_credentials(&amp;lease_id).await {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                Ok(_) =&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    tracing::info!(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        backend_id = %backend_id,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        lease_id = %lease_id,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        provider = %provider.provider_type(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        &quot;Renewed backend credentials&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                Err(e) =&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    tracing::error!(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        backend_id = %backend_id,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        provider = %provider.provider_type(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        error = %e,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        &quot;Failed to renew credentials, will fetch new ones&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>}</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">## Configuration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">### Proxy Configuration with Secrets Providers</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#### Option 1: HashiCorp Vault (Recommended for Dynamic Credentials)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<h1>prism-proxy.yaml</h1>
<p>data_port: 8980
admin_port: 8981</p>
<h1>Input Authentication</h1>
<p>input_auth:
type: mtls
ca_cert: /etc/prism/certs/ca.crt
server_cert: /etc/prism/certs/server.crt
server_key: /etc/prism/certs/server.key
client_cert_required: true
verify_depth: 3</p>
<h1>Output Authentication with Vault</h1>
<p>output_auth:
credential_provider: vault
vault:
address: <a href="https://vault.internal:8200" target="_blank" rel="noopener noreferrer">https://vault.internal:8200</a>
token_path: /var/run/secrets/vault-token
namespace: prism-prod</p>
<p>backends:</p>
<ul>
<li>
<p>name: postgres-main
type: postgres
auth:
type: vault-dynamic
path: database/creds/postgres-main
connection:
host: postgres.internal
port: 5432
database: users
ssl_mode: require</p>
</li>
<li>
<p>name: kafka-events
type: kafka
auth:
type: vault-dynamic
path: kafka/creds/producer-main
connection:
brokers: [kafka-1:9092, kafka-2:9092, kafka-3:9092]
security_protocol: SASL_SSL
sasl_mechanism: SCRAM-SHA-512</p>
</li>
<li>
<p>name: nats-messages
type: nats
auth:
type: vault-jwt
path: nats/creds/publisher
connection:
servers: [nats://nats-1:4222, nats://nats-2:4222]
tls_required: true</p>
</li>
</ul>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#### Option 2: AWS Secrets Manager (AWS Native)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<h1>prism-proxy.yaml</h1>
<p>data_port: 8980
admin_port: 8981</p>
<h1>Input Authentication</h1>
<p>input_auth:
type: mtls
ca_cert: /etc/prism/certs/ca.crt
server_cert: /etc/prism/certs/server.crt
server_key: /etc/prism/certs/server.key
client_cert_required: true</p>
<h1>Output Authentication with AWS Secrets Manager</h1>
<p>output_auth:
credential_provider: aws-secrets-manager
aws:
region: us-east-1
# Uses IAM role attached to EC2/ECS/EKS for authentication</p>
<p>backends:</p>
<ul>
<li>
<p>name: postgres-main
type: postgres
auth:
type: aws-secret</p>
<h1>Can use ARN or friendly name</h1>
<p>path: arn:aws:secretsmanager:us-east-1:123456789012:secret:prism/postgres-main</p>
<h1>Or: path: prism/postgres-main</h1>
<p>connection:
host: postgres.internal
port: 5432
database: users
ssl_mode: require</p>
</li>
<li>
<p>name: kafka-events
type: kafka
auth:
type: aws-secret
path: prism/kafka-producer
connection:
brokers: [kafka-1:9092, kafka-2:9092, kafka-3:9092]
security_protocol: SASL_SSL
sasl_mechanism: SCRAM-SHA-512</p>
</li>
</ul>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">**AWS Secrets Manager Secret Format** (JSON):</span><br></span></code></pre></div></div>
<p>{
&quot;username&quot;: &quot;prism-postgres-user&quot;,
&quot;password&quot;: &quot;securepassword123&quot;,
&quot;metadata&quot;: {
&quot;backend_type&quot;: &quot;postgres&quot;,
&quot;environment&quot;: &quot;production&quot;
}
}</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#### Option 3: Google Secret Manager (GCP Native)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<h1>prism-proxy.yaml</h1>
<p>data_port: 8980
admin_port: 8981</p>
<h1>Input Authentication</h1>
<p>input_auth:
type: mtls
ca_cert: /etc/prism/certs/ca.crt
server_cert: /etc/prism/certs/server.crt
server_key: /etc/prism/certs/server.key
client_cert_required: true</p>
<h1>Output Authentication with Google Secret Manager</h1>
<p>output_auth:
credential_provider: gcp-secret-manager
gcp:
project_id: prism-production-123456
# Uses Workload Identity or service account for authentication</p>
<p>backends:</p>
<ul>
<li>
<p>name: postgres-main
type: postgres
auth:
type: gcp-secret</p>
<h1>Can use full path or friendly name</h1>
<p>path: projects/prism-production-123456/secrets/prism-postgres-main/versions/latest</p>
<h1>Or: path: prism-postgres-main (auto-expanded)</h1>
<p>connection:
host: postgres.internal
port: 5432
database: users
ssl_mode: require</p>
</li>
<li>
<p>name: kafka-events
type: kafka
auth:
type: gcp-secret
path: prism-kafka-producer
connection:
brokers: [kafka-1:9092, kafka-2:9092, kafka-3:9092]
security_protocol: SASL_SSL
sasl_mechanism: SCRAM-SHA-512</p>
</li>
</ul>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#### Option 4: Azure Key Vault (Azure Native)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<h1>prism-proxy.yaml</h1>
<p>data_port: 8980
admin_port: 8981</p>
<h1>Input Authentication</h1>
<p>input_auth:
type: mtls
ca_cert: /etc/prism/certs/ca.crt
server_cert: /etc/prism/certs/server.crt
server_key: /etc/prism/certs/server.key
client_cert_required: true</p>
<h1>Output Authentication with Azure Key Vault</h1>
<p>output_auth:
credential_provider: azure-keyvault
azure:
vault_url: <a href="https://prism-prod.vault.azure.net" target="_blank" rel="noopener noreferrer">https://prism-prod.vault.azure.net</a>
tenant_id: 12345678-1234-1234-1234-123456789012
# Uses Managed Identity or Service Principal for authentication</p>
<p>backends:</p>
<ul>
<li>
<p>name: postgres-main
type: postgres
auth:
type: azure-secret
path: prism-postgres-main
connection:
host: postgres.internal
port: 5432
database: users
ssl_mode: require</p>
</li>
<li>
<p>name: kafka-events
type: kafka
auth:
type: azure-secret
path: prism-kafka-producer
connection:
brokers: [kafka-1:9092, kafka-2:9092, kafka-3:9092]
security_protocol: SASL_SSL
sasl_mechanism: SCRAM-SHA-512</p>
</li>
</ul>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">### Multi-Provider Deployment (Hybrid Cloud)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">For hybrid cloud deployments, you can configure different providers per backend:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<h1>prism-proxy.yaml</h1>
<p>data_port: 8980
admin_port: 8981</p>
<h1>Input Authentication</h1>
<p>input_auth:
type: mtls
ca_cert: /etc/prism/certs/ca.crt
server_cert: /etc/prism/certs/server.crt
server_key: /etc/prism/certs/server.key
client_cert_required: true</p>
<h1>Output Authentication - Multiple Providers</h1>
<p>output_auth:
providers:
# Vault for dynamic credentials (on-prem backends)
- name: vault-onprem
type: vault
vault:
address: <a href="https://vault.internal:8200" target="_blank" rel="noopener noreferrer">https://vault.internal:8200</a>
token_path: /var/run/secrets/vault-token
namespace: prism-prod</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># AWS Secrets for AWS backends</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- name: aws-prod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type: aws-secrets-manager</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  aws:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    region: us-east-1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># GCP Secrets for GCP backends</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- name: gcp-prod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type: gcp-secret-manager</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  gcp:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    project_id: prism-production-123456</span><br></span></code></pre></div></div>
<p>backends:</p>
<h1>On-prem Postgres using Vault dynamic credentials</h1>
<ul>
<li>name: postgres-main
type: postgres
auth:
provider: vault-onprem
type: vault-dynamic
path: database/creds/postgres-main
connection:
host: postgres.internal
port: 5432
database: users
ssl_mode: require</li>
</ul>
<h1>AWS RDS using AWS Secrets Manager</h1>
<ul>
<li>name: rds-analytics
type: postgres
auth:
provider: aws-prod
type: aws-secret
path: prism/rds-analytics
connection:
host: analytics.abc123.us-east-1.rds.amazonaws.com
port: 5432
database: analytics
ssl_mode: require</li>
</ul>
<h1>GCP Cloud SQL using GCP Secret Manager</h1>
<ul>
<li>name: cloudsql-reports
type: postgres
auth:
provider: gcp-prod
type: gcp-secret
path: prism-cloudsql-reports
connection:
host: /cloudsql/prism-prod:us-central1:reports
port: 5432
database: reports
ssl_mode: require</li>
</ul>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">## Security Considerations</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">### Credential Isolation</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Principle: Clients never see backend credentials</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">✓ Client presents certificate → Proxy validates</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">✓ Proxy fetches backend credentials → From Vault</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">✓ Proxy connects to backend → Using fetched credentials</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">✗ Client NEVER gets backend credentials</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="credential-rotation">Credential Rotation<a href="#credential-rotation" class="hash-link" aria-label="Direct link to Credential Rotation" title="Direct link to Credential Rotation" translate="no">​</a></h3>
<p>Automatic rotation schedule:</p>
<ol>
<li>Vault generates new credentials (TTL: 1 hour)</li>
<li>Proxy caches and renews every 30 minutes</li>
<li>On renewal failure, fetch new credentials</li>
<li>Gracefully drain old connections</li>
<li>Old credentials revoked by Vault after TTL</li>
</ol>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">### Audit Requirements</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Every data access must log:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- Client service identity (from mTLS cert)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- Namespace accessed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- Operation performed (get, put, delete, scan)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- Backend used</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- Success/failure</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- Latency</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">## Testing</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">### Integration Tests</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<p>#[tokio::test]
async fn test_mtls_authentication() {
let ca = generate_test_ca();
let client_cert = ca.issue_cert(&quot;test-service.prod.us-east-1&quot;);</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">let proxy = ProxyServer::new_test()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .with_ca(ca.cert())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .start()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .await;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">let client = Client::new()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .with_mtls(client_cert, client_key)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .connect(proxy.address())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .await</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .unwrap();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Should succeed with valid cert</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">let resp = client.get(&quot;test-namespace&quot;, &quot;key:123&quot;, &quot;field&quot;).await;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">assert!(resp.is_ok());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Should fail with expired cert</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">let expired_cert = ca.issue_cert_with_ttl(&quot;expired&quot;, Duration::seconds(-1));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">let bad_client = Client::new()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .with_mtls(expired_cert, key)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .connect(proxy.address())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .await;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">assert!(bad_client.is_err());</span><br></span></code></pre></div></div>
<p>}</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">## Open Questions</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1. **Certificate Authority**: Use company CA or service mesh (Linkerd/Istio)?</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - **Feedback**: Use Vault for certificate management and issuance</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - Vault PKI can act as an internal CA for mTLS certificates</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - Integrates with existing credential management workflow</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - Consider: Vault PKI vs external service mesh CA integration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2. **Credential Caching**: How long to cache backend credentials?</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - **Feedback**: Make it configurable, default to 24 hours</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - Cache duration should balance security (shorter = better) with Vault load (longer = fewer requests)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - Consider per-backend configuration (e.g., high-security backends use shorter TTL)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - Implement proactive renewal before expiry to avoid cache misses</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3. **Connection Pooling**: Pool connections per backend or per credential?</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - **Feedback**: Pool per-credential to avoid leaking data between connections if using multi-tenancy pattern</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - Per-credential pooling provides isolation when multiple namespaces share a backend</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - Prevents credential contamination across tenants</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - Trade-off: More connection pools = higher resource usage</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - Consider: Connection pool size limits and monitoring</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4. **Fallback Auth**: What to do when Vault is unavailable?</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - **Feedback**: Can we cache auth temporarily? What are the security risks and tradeoffs?</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - Options to explore:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     - Cache credentials beyond TTL during Vault outage (security risk: revocation won&#x27;t work)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     - Fail closed (deny all requests) vs fail open (use cached credentials)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     - Emergency static credentials (break-glass scenario)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - Security considerations:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     - Cached credentials can&#x27;t be rotated during outage</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     - Risk of using revoked credentials</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     - Audit trail gaps if Vault unavailable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - Recommended: Fail closed with configurable grace period for cached credentials</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - Document incident response procedure for Vault outage</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">5. **Observability**: How to monitor credential rotation and health?</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - **Feedback**: Use stats for credential events and general usage (no PII)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - Report credential TTL in session establishment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - Consider refresh tokens and how they fit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - Metrics to expose:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     - `credential.fetch.count` - Number of credential fetches from Vault</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     - `credential.renewal.count` - Successful/failed renewals</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     - `credential.ttl.seconds` - Remaining TTL of cached credentials</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     - `credential.cache.hit_rate` - Cache hit/miss ratio</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     - `connection.pool.size` - Per-credential pool sizes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     - `session.establishment.duration` - Time to establish authenticated session</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - Logs (no PII):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     - Credential fetch/renewal events with backend ID and lease ID</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     - Certificate rotation events</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     - Authentication failures (client identity but not credentials)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - Consider: Refresh token pattern for long-lived sessions to reduce Vault load</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">## References</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- [mTLS in Microservices](https://www.cloudflare.com/learning/access-management/what-is-mutual-tls/)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- [HashiCorp Vault Dynamic Secrets](https://www.vaultproject.io/docs/secrets/databases)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- [Kafka SASL/SCRAM](https://kafka.apache.org/documentation/#security_sasl_scram)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- [NATS JWT Authentication](https://docs.nats.io/running-a-nats-service/configuration/securing_nats/auth_intro/jwt)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- ADR-007: Authentication and Authorization</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- RFC-010: Admin Protocol with OIDC</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">## Revision History</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- 2025-10-09: Initial draft with mTLS and backend authentication flows</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- 2025-10-09: Expanded open questions with feedback on Vault CA, credential caching (24hr default), per-credential connection pooling, fallback auth strategies, and observability metrics</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- 2025-10-09: Added secrets provider abstraction supporting HashiCorp Vault, AWS Secrets Manager, Google Secret Manager, and Azure Key Vault with pluggable architecture, provider comparison matrix, and multi-provider hybrid cloud deployment patterns</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-tags-row"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/prism-data-layer/rfc/tags/authentication">authentication</a></li><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/prism-data-layer/rfc/tags/mtls">mtls</a></li><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/prism-data-layer/rfc/tags/proxy">proxy</a></li><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/prism-data-layer/rfc/tags/backends">backends</a></li><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/prism-data-layer/rfc/tags/security">security</a></li></ul></div></div><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/jrepp/prism-data-layer/tree/main/docs-cms/../docs-cms/rfcs/rfc-011-data-proxy-authentication.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/prism-data-layer/rfc/rfc-010"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Admin Protocol with OIDC Authentication • RFC-010</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/prism-data-layer/rfc/rfc-012"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Prism Network Gateway (prism-netgw) - Multi-Region Control Plane • RFC-012</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#abstract" class="table-of-contents__link toc-highlight">Abstract</a></li><li><a href="#motivation" class="table-of-contents__link toc-highlight">Motivation</a></li><li><a href="#architecture-overview" class="table-of-contents__link toc-highlight">Architecture Overview</a></li><li><a href="#input-authentication-client--proxy" class="table-of-contents__link toc-highlight">Input Authentication (Client → Proxy)</a><ul><li><a href="#mtls-certificate-based-authentication" class="table-of-contents__link toc-highlight">mTLS Certificate-Based Authentication</a></li><li><a href="#certificate-structure" class="table-of-contents__link toc-highlight">Certificate Structure</a></li><li><a href="#rust-implementation" class="table-of-contents__link toc-highlight">Rust Implementation</a></li><li><a href="#request-flow-with-mtls" class="table-of-contents__link toc-highlight">Request Flow with mTLS</a></li><li><a href="#certificate-rotation" class="table-of-contents__link toc-highlight">Certificate Rotation</a></li></ul></li><li><a href="#output-authentication-proxy--backend" class="table-of-contents__link toc-highlight">Output Authentication (Proxy → Backend)</a><ul><li><a href="#per-backend-authentication-strategies" class="table-of-contents__link toc-highlight">Per-Backend Authentication Strategies</a></li><li><a href="#credential-rotation" class="table-of-contents__link toc-highlight">Credential Rotation</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Documentation</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/prism-data-layer/docs/intro">Overview</a></li><li class="footer__item"><a class="footer__link-item" href="/prism-data-layer/docs/changelog">Change Log</a></li><li class="footer__item"><a class="footer__link-item" href="/prism-data-layer/adr">ADRs</a></li><li class="footer__item"><a class="footer__link-item" href="/prism-data-layer/rfc">RFCs</a></li><li class="footer__item"><a class="footer__link-item" href="/prism-data-layer/memos">Memos</a></li><li class="footer__item"><a class="footer__link-item" href="/prism-data-layer/prds">PRDs</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Project</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/jrepp/prism-data-layer" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright"><div>Copyright © 2025 Prism. Built with Docusaurus.</div><div style="margin-top:0.5rem;font-size:0.875rem;opacity:0.8"><span>Version <!-- -->12230f2</span><span> • </span><span>Built <!-- -->Oct 14, 2025, 10:32 AM PDT</span><span> • </span><span>Commit <!-- -->12230f2</span></div></div></div></div></footer></div>
</body>
</html>